<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#e89595">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>DIARIO MOJI</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  
  <style>
    :root {
      --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      --transition-speed: 0.3s;
      --border-radius: 16px;
      --shadow: 0 2px 12px rgba(0,0,0,0.08);
      --container-px: 16px;
      --safe-area-inset-bottom: env(safe-area-inset-bottom, 16px);
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: var(--font-family); margin: 0; padding: 0;
      background-color: var(--bg-primary); color: var(--text-primary);
      line-height: 1.5; font-size: 16px; overflow-x: hidden; touch-action: manipulation;
    }
    body.theme-pastel {
      --bg-primary: #fdf6f7; --bg-secondary: #ffffff; --text-primary: #2d2d2d; --text-secondary: #666666;
      --accent-primary: #e89595; --accent-secondary: #9cb6c9; --border-color: #e4d8dc;
      --success-color: #4caf50; --warning-color: #ff9800; --error-color: #f44336;
    }
    body.theme-cream {
      --bg-primary: #fdfaf2; --bg-secondary: #ffffff; --text-primary: #3c3c3c; --text-secondary: #666666;
      --accent-primary: #c89f68; --accent-secondary: #a8bba2; --border-color: #e7e2d9;
      --success-color: #4caf50; --warning-color: #ff9800; --error-color: #f44336;
    }
    body.theme-light {
      --bg-primary: #f8fafc; --bg-secondary: #ffffff; --text-primary: #1a202c; --text-secondary: #4a5568;
      --accent-primary: #3182ce; --accent-secondary: #38a169; --border-color: #e2e8f0;
      --success-color: #38a169; --warning-color: #ed8936; --error-color: #e53e3e;
    }
    body.theme-dark {
      --bg-primary: #0f0f18; --bg-secondary: #1a1a2e; --text-primary: #f0f0f0; --text-secondary: #a0a0b0;
      --accent-primary: #63b3ed; --accent-secondary: #68d391; --border-color: #2d3748;
      --success-color: #68d391; --warning-color: #f6ad55; --error-color: #fc8181;
    }
    .screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: var(--bg-primary); overflow-y: auto; -webkit-overflow-scrolling: touch;
      z-index: 1; opacity: 0; transition: opacity 0.3s; pointer-events: none;
    }
    .screen.active { opacity: 1; pointer-events: auto; z-index: 10; }
    .mobile-header {
      position: sticky; top: 0; z-index: 100; background: var(--bg-secondary);
      backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color);
      padding: 12px var(--container-px); display: flex; justify-content: space-between;
      align-items: center; min-height: 60px;
    }
    .mobile-header h1 { margin: 0; font-size: 1.3rem; font-weight: 700; color: var(--accent-primary); }
    .header-actions { display: flex; gap: 8px; }
    .btn-header {
      padding: 10px 14px; background: var(--bg-primary); border: 1px solid var(--border-color);
      border-radius: 10px; cursor: pointer; transition: all var(--transition-speed);
      font-weight: 600; min-height: 44px; display: flex; align-items: center; justify-content: center;
    }
    .icon-button {
      width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center;
      justify-content: center; background: var(--bg-primary); border: 1px solid var(--border-color);
      font-size: 1.2rem; cursor: pointer; transition: all var(--transition-speed);
    }
    .icon-button:active, .btn-header:active { transform: scale(0.95); background: var(--accent-primary); color: white; }
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-secondary);
      border-top: 1px solid var(--border-color); display: none; justify-content: space-around;
      padding: 8px var(--container-px) calc(8px + var(--safe-area-inset-bottom));
      z-index: 1000; backdrop-filter: blur(10px); transform: translateZ(0);
    }
    .bottom-nav.visible { display: flex; }
    .nav-item {
      display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px 12px;
      background: none; border: none; color: var(--text-secondary); font-size: 0.75rem;
      cursor: pointer; transition: all var(--transition-speed); border-radius: 12px; min-width: 60px; flex: 1;
    }
    .nav-item.active { color: var(--accent-primary); background: var(--bg-primary); }
    .nav-icon { font-size: 1.3rem; }
    .main-content { padding: 20px var(--container-px) 120px; max-width: 100%; overflow-x: hidden; }
    .widget {
      background: var(--bg-secondary); border-radius: var(--border-radius); padding: 20px;
      margin-bottom: 16px; border: 1px solid var(--border-color); box-shadow: var(--shadow);
    }
    .widget h2 {
      margin: 0 0 16px 0; font-size: 1.1rem; font-weight: 600; color: var(--text-primary);
      border-bottom: 2px solid var(--border-color); padding-bottom: 8px;
    }
    .emotion-selector { display: grid; grid-template-columns: repeat(auto-fit, minmax(50px, 1fr)); gap: 12px; margin-bottom: 20px; }
    .emotion-emoji {
      font-size: 2rem; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      filter: grayscale(80%) brightness(0.8); opacity: 0.7; padding: 8px; border-radius: 50%;
      display: flex; justify-content: center; align-items: center; background: var(--bg-primary); aspect-ratio: 1;
    }
    .emotion-emoji.selected {
      filter: grayscale(0%) brightness(1); opacity: 1; transform: scale(1.15);
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }
    .intensity-slider-container { background: var(--bg-primary); padding: 16px; border-radius: var(--border-radius); margin-top: 16px; }
    input[type="range"] {
      width: 100%; height: 8px; border-radius: 4px; outline: none; -webkit-appearance: none; margin: 8px 0;
      background: linear-gradient(to right, var(--error-color), var(--warning-color), var(--success-color));
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 24px; height: 24px; border-radius: 50%; background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3); cursor: pointer; border: 2px solid var(--accent-primary);
    }
    .accordion { margin-bottom: 16px; border-radius: var(--border-radius); overflow: hidden; border: 1px solid var(--border-color); }
    .accordion-header {
      background: var(--bg-secondary); padding: 16px 20px; cursor: pointer; display: flex;
      justify-content: space-between; align-items: center; font-weight: 600; transition: background-color var(--transition-speed);
    }
    .accordion-header::after { content: '‚ñº'; font-size: 0.8rem; transition: transform var(--transition-speed); }
    .accordion-header.active::after { transform: rotate(180deg); }
    .accordion-content { background: var(--bg-primary); max-height: 0; overflow: hidden; transition: max-height var(--transition-speed); }
    .accordion-content.active { max-height: 1000px; padding: 20px; }
    .editor-container { border: 2px solid var(--border-color); border-radius: var(--border-radius); overflow: hidden; background: var(--bg-primary); }
    #editor { min-height: 200px; padding: 16px; font-size: 16px; line-height: 1.6; outline: none; }
    #editor:empty:before { content: attr(placeholder); color: var(--text-secondary); }
    .touch-list { list-style: none; padding: 0; margin: 0; }
    .touch-list li { display: flex; align-items: center; padding: 14px 0; border-bottom: 1px solid var(--border-color); min-height: 52px; }
    .habit-item { padding: 14px 0; border-bottom: 1px solid var(--border-color); }
    .habit-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .habit-title { font-weight: 600; }
    .habit-category { font-size: 0.8em; color: var(--text-secondary); background-color: var(--bg-primary); padding: 2px 8px; border-radius: 8px; }
    .habit-subcategory-label { text-align: center; margin-top: 8px; font-size: 0.9em; color: var(--accent-primary); font-weight: 500; min-height: 1.2em; }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white; border: none; padding: 16px 24px; border-radius: var(--border-radius);
      cursor: pointer; transition: all var(--transition-speed); font-weight: 600; font-size: 1rem;
      width: 100%; min-height: 52px; display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn-primary:active { transform: scale(0.98); }
    .modal { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); z-index: 2000; }
    .modal-content {
      background: var(--bg-secondary); margin: 20px; border-radius: var(--border-radius); padding: 20px;
      max-height: calc(100vh - 100px); overflow-y: auto; -webkit-overflow-scrolling: touch;
      position: relative; animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    @keyframes slideUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
    .close-btn {
      position: absolute; top: 16px; right: 16px; width: 40px; height: 40px; border-radius: 50%;
      background: var(--bg-primary); border: none; display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 1.2rem; color: var(--text-secondary); z-index: 1;
    }
    .tabs { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; justify-content: center; }
    .tab {
      padding: 12px 20px; background: var(--bg-primary); border: none; border-radius: 12px; cursor: pointer;
      transition: all var(--transition-speed); white-space: nowrap; font-weight: 600; color: var(--text-secondary); min-height: 44px;
    }
    .tab.active { background: var(--accent-primary); color: white; }
    
    /* ## BOTON-FIX: Aqu√≠ est√° la correcci√≥n para el bug de los botones ## */
    .toast {
      position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(100px);
      background: var(--bg-secondary); color: var(--text-primary); padding: 12px 20px;
      border-radius: var(--border-radius); box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 10000;
      transition: all 0.3s ease; border: 1px solid var(--border-color); max-width: 90%; text-align: center;
      opacity: 0;
      pointer-events: none; /* <-- ASEGURA que sea invisible a los clics cuando est√° oculto */
    }
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
      pointer-events: auto; /* <-- PERMITE clics solo cuando es visible */
    }
    
    .flatpickr-day.has-entry {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)) !important;
      color: white !important; border-radius: 50% !important; border: none !important;
    }
    .flatpickr-day.all-habits-done { background: linear-gradient(135deg, #FFD700, #F0C000) !important; color: #333 !important; font-weight: bold !important; }
    .flatpickr-day.today { border: 2px solid var(--accent-primary) !important; }
    .account-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid var(--border-color); }
    .account-item.principal { background-color: var(--bg-primary); border-radius: var(--border-radius); padding: 14px; margin: 8px 0; border: 2px solid var(--accent-primary); }
    .account-balance { font-weight: 600; color: var(--accent-primary); }
    .account-actions { display: flex; gap: 8px; }
    .btn-small { padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer; font-size: 0.8rem; font-weight: 600; }
    .btn-danger { background: var(--error-color); color: white; }
    .btn-success { background: var(--success-color); color: white; }
    .btn-secondary { background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color); }
    .btn-disabled { background: var(--border-color); color: var(--text-secondary); cursor: not-allowed; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: var(--border-radius);
      background: var(--bg-primary); color: var(--text-primary); font-size: 1rem;
    }
    .stats-grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 600px) { .stats-grid { grid-template-columns: 1fr 1fr; } }
    .stat-card { background: var(--bg-primary); border-radius: var(--border-radius); padding: 20px; text-align: center; }
    .stat-value { font-size: 2.5rem; font-weight: 700; margin: 10px 0; }
    .stat-label { color: var(--text-secondary); font-size: 0.9rem; }
    .time-filters { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 8px; }
    .time-filter {
      padding: 10px 16px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 20px;
      cursor: pointer; font-size: 0.9rem; font-weight: 600; white-space: nowrap;
    }
    .time-filter.active { background: var(--accent-primary); color: white; border-color: var(--accent-primary); }
    .chart-container { height: 300px; position: relative; margin: 16px 0; }
  </style>
</head>
<body class="theme-pastel">

  <div id="welcome-screen" class="screen active">
    <div class="main-content" style="display: flex; align-items: center; justify-content: center; min-height: 100vh;">
      <div class="widget" style="text-align: center; max-width: 400px;">
        <h1 style="font-size: 2.5rem; margin-bottom: 16px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">üìî DIARIO MOJI</h1>
        <p style="color: var(--text-secondary); margin-bottom: 32px; font-size: 1.1rem;">Tu espacio personal para reflexionar y crecer</p>
        <div style="display: flex; flex-direction: column; gap: 16px;">
          <button class="btn-primary" id="btn-new-diary"><span>üìù</span> Crear Nuevo Diario</button>
          <button class="btn-primary" id="btn-open-diary"><span>üìÇ</span> Abrir Diario Existente</button>
        </div>
        <input type="file" id="import-file-input" accept=".xml" style="display: none;">
      </div>
    </div>
  </div>

  <div id="name-prompt-screen" class="screen">
    <div class="mobile-header">
      <button class="icon-button" id="btn-back-name">‚Üê</button>
      <h1>Nuevo Diario</h1>
      <div style="width: 44px;"></div>
    </div>
    <div class="main-content">
      <div class="widget" style="text-align: center;">
        <h2>¬øC√≥mo te llamas?</h2>
        <input type="text" id="owner-name-input" placeholder="Escribe tu nombre..." style="width: 100%; padding: 16px; border-radius: var(--border-radius); font-size: 1.1rem; margin-bottom: 24px;">
        <button class="btn-primary" id="btn-confirm-name">Continuar</button>
      </div>
    </div>
  </div>

  <div id="main-diary-screen" class="screen">
    <div class="mobile-header">
      <h1 id="diary-owner-name">Mi Diario</h1>
      <div class="header-actions">
        <button class="icon-button" id="btn-calendar-header">üìÖ</button>
        <button class="icon-button" id="btn-settings" title="Ajustes">‚öôÔ∏è</button>
      </div>
    </div>
    <div class="main-content">
      <div class="widget">
        <h2 id="emotion-date-label">C√≥mo te sientes hoy</h2>
        <div class="emotion-selector" id="emotion-selector"></div>
        <div class="intensity-slider-container">
          <label for="emotion-intensity">Intensidad: <span id="intensity-value">5</span>/10</label>
          <input type="range" id="emotion-intensity" min="1" max="10" value="5">
        </div>
      </div>
      <div class="accordion">
        <div class="accordion-header">Mi Entrada de Hoy</div>
        <div class="accordion-content">
          <div class="editor-container">
            <div id="editor" contenteditable="true" placeholder="Escribe sobre tu d√≠a..."></div>
          </div>
        </div>
      </div>
      <div class="accordion">
        <div class="accordion-header">Mi Bienestar</div>
        <div class="accordion-content">
          <div>
            <label for="physical-activity">Actividad F√≠sica: <span id="physical-activity-value">5</span>/10</label>
            <input type="range" id="physical-activity" min="1" max="10" value="5">
          </div>
          <div style="margin-top:20px;">
            <label for="water-intake">Vasos de Agua: <span id="water-intake-value">0</span></label>
            <input type="range" id="water-intake" min="0" max="12" value="0">
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="habitos-screen" class="screen">
    <div class="mobile-header">
      <div style="width: 44px;"></div>
      <h1>H√°bitos</h1>
      <div class="header-actions">
          <button class="btn-header" id="btn-manage-habits" style="font-size: 0.8rem; padding: 0 12px;">Mis H√°bitos</button>
          <button class="icon-button" id="btn-show-add-habit-modal">+</button>
      </div>
    </div>
    <div class="main-content">
        <div class="widget">
            <h2 id="habits-date-label">H√°bitos de Hoy</h2>
            <div id="habits-list-sliders"></div>
        </div>
    </div>
  </div>

  <div id="calendar-screen" class="screen">
    <div class="mobile-header">
      <button class="icon-button" id="btn-calendar-back">‚Üê</button>
      <h1>Calendario</h1>
      <div style="width: 44px;"></div>
    </div>
    <div class="main-content">
      <div class="widget">
        <div id="calendar"></div>
      </div>
    </div>
  </div>

  <div id="expenses-screen" class="screen">
    <div class="mobile-header">
      <button class="icon-button" id="btn-expenses-back">‚Üê</button>
      <h1>Gastos</h1>
      <div style="width: 44px;"></div>
    </div>
    <div class="main-content">
      <div class="widget">
        <h2>Resumen Financiero</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Balance Total</div>
            <div class="stat-value" id="total-balance">$0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label" id="main-account-name">Cuenta Principal</div>
            <div class="stat-value" id="main-account-balance">$0</div>
          </div>
        </div>
      </div>
      <div class="accordion">
        <div class="accordion-header">Registrar Transacci√≥n</div>
        <div class="accordion-content">
          <div class="form-group"><label for="transaction-type">Tipo:</label><select id="transaction-type"><option value="expense">Gasto</option><option value="income">Ingreso</option></select></div>
          <div class="form-group"><label for="transaction-amount">Monto:</label><input type="number" id="transaction-amount" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label for="transaction-description">Descripci√≥n:</label><input type="text" id="transaction-description"></div>
          <div class="form-group"><label for="transaction-account">Cuenta:</label><select id="transaction-account"></select></div>
          <button class="btn-primary" id="btn-add-transaction">Agregar Transacci√≥n</button>
        </div>
      </div>
      <div class="accordion">
        <div class="accordion-header">Gesti√≥n de Cuentas</div>
        <div class="accordion-content">
          <div id="accounts-list"></div>
          <h3 style="margin-top: 24px;">Agregar Nueva Cuenta</h3>
          <div class="form-group"><label for="new-account-name">Nombre:</label><input type="text" id="new-account-name"></div>
          <div class="form-group"><label for="new-account-balance">Saldo inicial:</label><input type="number" id="new-account-balance" step="0.01" value="0"></div>
          <button class="btn-primary" id="btn-add-account">Agregar Cuenta</button>

          <h3 style="margin-top: 24px;">Transferencia entre Cuentas</h3>
          <div class="form-group"><label for="transfer-from">Desde:</label><select id="transfer-from"></select></div>
          <div class="form-group"><label for="transfer-to">Hacia:</label><select id="transfer-to"></select></div>
          <div class="form-group"><label for="transfer-amount">Monto:</label><input type="number" id="transfer-amount" step="0.01" placeholder="0.00"></div>
          <button class="btn-primary" id="btn-transfer">Realizar Transferencia</button>
        </div>
      </div>
      <div class="accordion">
        <div class="accordion-header">√öltimas Transacciones</div>
        <div class="accordion-content">
          <ul class="touch-list" id="transactions-list"></ul>
        </div>
      </div>
    </div>
  </div>
  
  <div id="stats-screen" class="screen">
    <div class="mobile-header">
      <button class="icon-button" id="btn-stats-back">‚Üê</button>
      <h1>Estad√≠sticas</h1>
      <div style="width: 44px;"></div>
    </div>
    <div class="main-content">
      <div class="time-filters">
        <button class="time-filter active" data-period="week">Semana</button>
        <button class="time-filter" data-period="month">Mes</button>
        <button class="time-filter" data-period="year">A√±o</button>
        <button class="time-filter" data-period="all">Todo</button>
      </div>
      <div class="tabs">
        <button class="tab active" data-tab="emociones">Emociones</button>
        <button class="tab" data-tab="finanzas">Finanzas</button>
        <button class="tab" data-tab="habitos">H√°bitos</button>
        <button class="tab" data-tab="bienestar">Bienestar</button>
      </div>
      <div id="emociones-tab" class="tab-content">
        <div class="widget">
          <h2>Resumen Emocional</h2>
          <div class="stats-grid">
            <div class="stat-card"><div class="stat-label">√çndice de Bienestar</div><div class="stat-value" id="wellness-index">--</div></div>
            <div class="stat-card"><div class="stat-label">Emoci√≥n Principal</div><div class="stat-value" id="main-emotion">--</div></div>
          </div>
        </div>
        <div class="widget"><h2>Evoluci√≥n Emocional</h2><div class="chart-container"><canvas id="emotion-chart"></canvas></div></div>
      </div>
      <div id="finanzas-tab" class="tab-content" style="display: none;">
        <div class="widget">
          <h2>Resumen Financiero</h2>
          <div class="stats-grid">
            <div class="stat-card"><div class="stat-label">Ingresos</div><div class="stat-value" id="total-income">$0</div></div>
            <div class="stat-card"><div class="stat-label">Gastos</div><div class="stat-value" id="total-expenses">$0</div></div>
          </div>
        </div>
        <div class="widget"><h2>Distribuci√≥n del Balance Total</h2><div class="chart-container"><canvas id="balance-distribution-chart"></canvas></div></div>
        <div class="widget"><h2>Distribuci√≥n de Gastos</h2><div class="chart-container"><canvas id="expenses-chart"></canvas></div></div>
      </div>
      <div id="habitos-tab" class="tab-content" style="display: none;">
        <div class="widget">
            <h2>Resumen de H√°bitos</h2>
            <div class="stats-grid"><div class="stat-card"><div class="stat-label">Promedio de H√°bitos Completados</div><div class="stat-value" id="avg-habits-completed">--</div><div class="stat-label">Por d√≠a</div></div></div>
        </div>
        <div class="widget"><h2>Rendimiento por H√°bito</h2><ul class="touch-list" id="habits-stats-list"></ul></div>
      </div>
      <div id="bienestar-tab" class="tab-content" style="display: none;">
        <div class="widget">
          <h2>Estad√≠sticas de Bienestar</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Actividad F√≠sica Promedio</div>
              <div class="stat-value" id="avg-activity">--</div>
              <div class="stat-label">Intensidad (1-10)</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Agua Promedio</div>
              <div class="stat-value" id="avg-water">--</div>
              <div class="stat-label">Vasos por d√≠a</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="settings-modal" class="modal screen">
    <div class="modal-content">
      <button class="close-btn">&times;</button>
      <h2>Ajustes</h2>
      <div class="form-group"><label>Nombre del Diario</label><input type="text" id="diary-name-input"></div>
      <div class="form-group"><label>Tema Visual</label><select id="theme-selector"><option value="pastel">Pastel</option><option value="cream">Crema</option><option value="light">Claro</option><option value="dark">Oscuro</option></select></div>
      <button class="btn-primary" id="btn-save-settings">Guardar Cambios</button>
      <button class="btn-primary" id="btn-export-diary" style="margin-top: 12px; background: var(--accent-secondary);">Exportar Diario</button>
      <button class="btn-primary btn-danger" id="btn-reset-diary" style="margin-top: 12px;">Resetear Diario</button>
    </div>
  </div>
  <div id="add-habit-modal" class="modal screen">
    <div class="modal-content">
      <button class="close-btn">&times;</button>
      <h2>Agregar H√°bito</h2>
      <div class="form-group"><label for="new-habit-name">Nombre:</label><input type="text" id="new-habit-name" placeholder="Ej: Rutina de ma√±ana"></div>
      <div class="form-group"><label for="new-habit-category">Categor√≠a:</label><input type="text" id="new-habit-category" placeholder="Ej: Bienestar"></div>
      <div class="form-group"><label for="new-habit-subcategories">Subcategor√≠as (separadas por coma):</label><textarea id="new-habit-subcategories" rows="3" placeholder="Ej: Tender la cama, Meditar"></textarea></div>
      <button class="btn-primary" id="btn-add-habit">Agregar H√°bito</button>
    </div>
  </div>
  <div id="manage-habits-modal" class="modal screen">
    <div class="modal-content">
      <button class="close-btn">&times;</button>
      <h2>Mis H√°bitos</h2>
      <div id="habits-management-list"></div>
    </div>
  </div>
  <div id="edit-habit-modal" class="modal screen">
    <div class="modal-content">
      <button class="close-btn">&times;</button>
      <h2>Editar H√°bito</h2>
      <div class="form-group"><label for="edit-habit-name">Nombre:</label><input type="text" id="edit-habit-name"></div>
      <div class="form-group"><label for="edit-habit-category">Categor√≠a:</label><input type="text" id="edit-habit-category"></div>
      <div class="form-group"><label for="edit-habit-subcategories">Subcategor√≠as:</label><textarea id="edit-habit-subcategories" rows="3"></textarea></div>
      <button class="btn-primary" id="btn-save-habit">Guardar Cambios</button>
    </div>
  </div>
  <div id="edit-account-modal" class="modal screen">
    <div class="modal-content">
      <button class="close-btn">&times;</button>
      <h2>Editar Cuenta</h2>
      <div class="form-group"><label for="edit-account-name">Nombre:</label><input type="text" id="edit-account-name"></div>
      <div class="form-group"><label for="edit-account-balance">Saldo:</label><input type="number" id="edit-account-balance" step="0.01"></div>
      <button class="btn-primary" id="btn-save-account">Guardar Cambios</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <nav class="bottom-nav">
    <button class="nav-item active" data-screen="diario"><span class="nav-icon">üìî</span><span>Diario</span></button>
    <button class="nav-item" data-screen="habitos"><span class="nav-icon">üìã</span><span>H√°bitos</span></button>
    <button class="nav-item" data-screen="gastos"><span class="nav-icon">üí∞</span><span>Gastos</span></button>
    <button class="nav-item" data-screen="estadisticas"><span class="nav-icon">üìä</span><span>Estad√≠sticas</span></button>
  </nav>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    let diaryData = {};
    let currentDate = new Date().toISOString().split('T')[0];
    let calendarInstance, emotionChartInstance, expensesChartInstance, balanceChartInstance;
    let editingAccountId, editingHabitId;

    const ALL_SCREENS = ['welcome-screen', 'name-prompt-screen', 'main-diary-screen', 'habitos-screen', 'calendar-screen', 'expenses-screen', 'stats-screen'];
    const EMOTIONS = [
        {e:'üòÑ', n:'Alegr√≠a', v:2}, {e:'üòä', n:'Calma', v:1}, {e:'üòê', n:'Neutral', v:0},
        {e:'üòü', n:'Ansiedad', v:-1}, {e:'üò≠', n:'Tristeza', v:-2}, {e:'üò†', n:'Enojo', v:-2},
        {e:'üò±', n:'Miedo', v:-1}, {e:'üòç', n:'Amor', v:2}, {e:'ü§î', n:'Reflexi√≥n', v:0},
        {e:'üò¥', n:'Cansancio', v:-1}
    ];
    
    function initApp() {
      setupEventListeners();
      renderEmotionSelector();
      setupAccordions();
      if (loadDataFromLocalStorage()) {
        document.getElementById('diary-owner-name').textContent = `Diario de ${diaryData.ownerName}`;
        document.body.className = `theme-${diaryData.settings.theme || 'pastel'}`;
        document.querySelector('.bottom-nav').classList.add('visible');
        showScreen('main-diary-screen');
        switchBottomNav('diario');
        loadEntryForDate(currentDate);
        showToast(`¬°Bienvenido/a de nuevo, ${diaryData.ownerName}!`);
      } else {
        showScreen('welcome-screen');
      }
    }

    function setupEventListeners() {
      document.getElementById('btn-new-diary').addEventListener('click', () => showScreen('name-prompt-screen'));
      document.getElementById('btn-confirm-name').addEventListener('click', createNewDiary);

      document.querySelector('.bottom-nav').addEventListener('click', (e) => {
          const navButton = e.target.closest('.nav-item');
          if (navButton && navButton.dataset.screen) {
              switchBottomNav(navButton.dataset.screen);
          }
      });
      
      ['btn-calendar-back', 'btn-expenses-back', 'btn-stats-back'].forEach(id => document.getElementById(id).addEventListener('click', () => switchBottomNav('diario')));
      document.getElementById('btn-calendar-header').addEventListener('click', () => switchBottomNav('calendario'));
      document.getElementById('emotion-intensity').addEventListener('input', (e) => { document.getElementById('intensity-value').textContent = e.target.value; saveEmotionData(); });
      document.getElementById('physical-activity').addEventListener('input', (e) => { document.getElementById('physical-activity-value').textContent = e.target.value; saveWellbeingData(); });
      document.getElementById('water-intake').addEventListener('input', (e) => { document.getElementById('water-intake-value').textContent = e.target.value; saveWellbeingData(); });
      document.getElementById('editor').addEventListener('input', debounce(saveEntryText, 500));
      document.getElementById('btn-show-add-habit-modal').addEventListener('click', () => showModal('add-habit-modal'));
      document.getElementById('btn-manage-habits').addEventListener('click', () => { updateHabitsManagementList(); showModal('manage-habits-modal'); });
      document.getElementById('btn-add-habit').addEventListener('click', addNewHabit);
      document.getElementById('btn-save-habit').addEventListener('click', saveHabitChanges);
      document.getElementById('btn-add-transaction').addEventListener('click', addNewTransaction);
      document.getElementById('btn-add-account').addEventListener('click', addNewAccount);
      document.getElementById('btn-save-account').addEventListener('click', saveAccountChanges);
      document.getElementById('btn-transfer').addEventListener('click', transferBetweenAccounts);
      document.getElementById('btn-settings').addEventListener('click', () => showModal('settings-modal'));
      document.getElementById('btn-save-settings').addEventListener('click', saveSettings);
      document.getElementById('btn-export-diary').addEventListener('click', exportDiary);
      document.getElementById('btn-reset-diary').addEventListener('click', resetDiary);
      document.querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', (e) => e.target.closest('.modal').classList.remove('active')));
      document.querySelectorAll('.tab').forEach(tab => tab.addEventListener('click', (e) => switchTab(e.currentTarget.dataset.tab)));
      document.querySelectorAll('.time-filter').forEach(filter => filter.addEventListener('click', (e) => switchTimeFilter(e.currentTarget.dataset.period)));
    }

    function showScreen(screenIdToShow) { ALL_SCREENS.forEach(id => document.getElementById(id)?.classList.toggle('active', id === screenIdToShow)); }
    function switchBottomNav(screenName) {
      document.querySelectorAll('.nav-item').forEach(item => item.classList.toggle('active', item.dataset.screen === screenName));
      const screenMap = { diario: 'main-diary-screen', habitos: 'habitos-screen', gastos: 'expenses-screen', estadisticas: 'stats-screen', calendario: 'calendar-screen' };
      showScreen(screenMap[screenName]);
      if (screenName === 'gastos') updateExpenses();
      else if (screenName === 'estadisticas') updateStats();
      else if (screenName === 'calendario') initCalendar();
      else if (screenName === 'habitos') updateHabitsScreen();
    }
    function showModal(modalId) { document.getElementById(modalId)?.classList.add('active'); }
    function setupAccordions() {
      document.querySelectorAll('.accordion-header').forEach(h => h.addEventListener('click', () => { h.classList.toggle('active'); h.nextElementSibling.classList.toggle('active'); }));
    }
    function renderEmotionSelector() {
      const container = document.getElementById('emotion-selector');
      container.innerHTML = EMOTIONS.map(e => `<div class="emotion-emoji" data-name="${e.n}" title="${e.n}">${e.e}</div>`).join('');
      container.addEventListener('click', (e) => {
        const target = e.target.closest('.emotion-emoji');
        if (target) {
          container.querySelectorAll('.emotion-emoji.selected').forEach(el => el.classList.remove('selected'));
          target.classList.add('selected');
          saveEmotionData();
        }
      });
    }
    function updateHabitsScreen() {
        const dateObj = new Date(currentDate + 'T12:00:00');
        document.getElementById('habits-date-label').textContent = `H√°bitos del ${dateObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric' })}`;
        updateHabitsListSliders();
    }
    function createNewDiary() {
      const name = document.getElementById('owner-name-input').value.trim();
      if (!name) return showToast('Por favor, introduce tu nombre');
      diaryData = {
        ownerName: name, settings: { theme: 'pastel' }, entries: {}, habits: [],
        accounts: [{ id: Date.now(), name: 'Cuenta Principal', balance: 0, isDefault: true }], transactions: []
      };
      document.getElementById('diary-owner-name').textContent = `Diario de ${name}`;
      showScreen('main-diary-screen');
      document.querySelector('.bottom-nav').classList.add('visible');
      saveDataToLocalStorage();
      showToast(`¬°Bienvenido/a, ${name}!`);
    }
    function loadEntryForDate(date) {
      currentDate = date;
      const entry = diaryData.entries[date] || {};
      document.querySelector('.emotion-emoji.selected')?.classList.remove('selected');
      if (entry.emotion) {
        document.querySelector(`.emotion-emoji[data-name="${entry.emotion.name}"]`)?.classList.add('selected');
        document.getElementById('emotion-intensity').value = entry.emotion.intensity;
        document.getElementById('intensity-value').textContent = entry.emotion.intensity;
      } else {
        document.getElementById('emotion-intensity').value = 5;
        document.getElementById('intensity-value').textContent = 5;
      }
      document.getElementById('editor').innerHTML = entry.text || '';
      document.getElementById('physical-activity').value = entry.physicalActivity || 5;
      document.getElementById('physical-activity-value').textContent = entry.physicalActivity || 5;
      document.getElementById('water-intake').value = entry.waterIntake || 0;
      document.getElementById('water-intake-value').textContent = entry.waterIntake || 0;
      const dateObj = new Date(date + 'T12:00:00');
      document.getElementById('emotion-date-label').textContent = `C√≥mo te sentiste el ${dateObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' })}`;
      if (document.getElementById('habitos-screen').classList.contains('active')) updateHabitsScreen();
    }
    function saveEmotionData() {
      const selected = document.querySelector('.emotion-emoji.selected');
      if (selected) {
        if (!diaryData.entries[currentDate]) diaryData.entries[currentDate] = {};
        diaryData.entries[currentDate].emotion = { name: selected.dataset.name, intensity: parseInt(document.getElementById('emotion-intensity').value) };
        saveDataToLocalStorage();
      }
    }
    function saveWellbeingData() {
        if (!diaryData.entries[currentDate]) diaryData.entries[currentDate] = {};
        diaryData.entries[currentDate].physicalActivity = parseInt(document.getElementById('physical-activity').value);
        diaryData.entries[currentDate].waterIntake = parseInt(document.getElementById('water-intake').value);
        saveDataToLocalStorage();
    }
    function saveEntryText() {
      if (!diaryData.entries[currentDate]) diaryData.entries[currentDate] = {};
      diaryData.entries[currentDate].text = document.getElementById('editor').innerHTML;
      saveDataToLocalStorage();
    }
    function saveSettings() {
      const name = document.getElementById('diary-name-input').value.trim();
      if (name) { diaryData.ownerName = name; document.getElementById('diary-owner-name').textContent = `Diario de ${name}`; }
      diaryData.settings.theme = document.getElementById('theme-selector').value;
      document.body.className = `theme-${diaryData.settings.theme}`;
      document.getElementById('settings-modal').classList.remove('active');
      saveDataToLocalStorage();
      showToast('Configuraci√≥n guardada');
    }
    function addNewHabit() {
        const name = document.getElementById('new-habit-name').value.trim();
        if (!name) return showToast('El nombre del h√°bito es obligatorio');
        const subcategories = document.getElementById('new-habit-subcategories').value.trim().split(',').map(s => s.trim()).filter(Boolean);
        if (!diaryData.habits) diaryData.habits = [];
        diaryData.habits.push({ id: Date.now(), text: name, category: document.getElementById('new-habit-category').value.trim(), subcategories: subcategories.length > 0 ? subcategories : [name] });
        ['new-habit-name', 'new-habit-category', 'new-habit-subcategories'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('add-habit-modal').classList.remove('active');
        updateHabitsScreen();
        saveDataToLocalStorage();
        showToast('H√°bito agregado');
    }
    function editHabit(habitId) {
        const habit = diaryData.habits.find(h => h.id === habitId);
        if (!habit) return;
        editingHabitId = habitId;
        document.getElementById('manage-habits-modal').classList.remove('active');
        document.getElementById('edit-habit-name').value = habit.text;
        document.getElementById('edit-habit-category').value = habit.category || '';
        document.getElementById('edit-habit-subcategories').value = habit.subcategories.join(', ');
        showModal('edit-habit-modal');
    }
    function saveHabitChanges() {
        if (!editingHabitId) return;
        const habit = diaryData.habits.find(h => h.id === editingHabitId);
        const name = document.getElementById('edit-habit-name').value.trim();
        if (!habit || !name) return showToast('Datos inv√°lidos');
        habit.text = name;
        habit.category = document.getElementById('edit-habit-category').value.trim();
        const subcategories = document.getElementById('edit-habit-subcategories').value.trim().split(',').map(s => s.trim()).filter(Boolean);
        habit.subcategories = subcategories.length > 0 ? subcategories : [name];
        document.getElementById('edit-habit-modal').classList.remove('active');
        updateHabitsScreen();
        saveDataToLocalStorage();
        showToast('H√°bito actualizado');
        editingHabitId = null;
    }
    function deleteHabit(habitId) {
        diaryData.habits = diaryData.habits.filter(h => h.id !== habitId);
        Object.values(diaryData.entries).forEach(entry => { if (entry.habitsProgress?.[habitId]) delete entry.habitsProgress[habitId]; });
        updateHabitsManagementList();
        updateHabitsScreen();
        saveDataToLocalStorage();
        showToast('H√°bito eliminado');
    }
    function updateHabitsListSliders() {
        const container = document.getElementById('habits-list-sliders');
        if (!diaryData.habits?.length) return container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Agrega tu primer h√°bito usando el bot√≥n "+".</p>';
        const progress = diaryData.entries[currentDate]?.habitsProgress || {};
        container.innerHTML = diaryData.habits.map(h => {
            const steps = h.subcategories.length;
            const currentStep = progress[h.id] || 0;
            const subText = currentStep > 0 ? h.subcategories[currentStep - 1] : "Sin empezar";
            return `<div class="habit-item"><div class="habit-item-header"><span class="habit-title">${h.text}</span>${h.category ? `<span class="habit-category">${h.category}</span>` : ''}</div><input type="range" class="habit-slider" data-id="${h.id}" min="0" max="${steps}" value="${currentStep}"><div class="habit-subcategory-label" id="label-habit-${h.id}">${subText} (${currentStep}/${steps})</div></div>`;
        }).join('');
        container.querySelectorAll('.habit-slider').forEach(slider => {
            slider.addEventListener('input', e => {
                const id = e.target.dataset.id, value = parseInt(e.target.value), h = diaryData.habits.find(hb => hb.id == id);
                if (!diaryData.entries[currentDate]) diaryData.entries[currentDate] = {};
                if (!diaryData.entries[currentDate].habitsProgress) diaryData.entries[currentDate].habitsProgress = {};
                diaryData.entries[currentDate].habitsProgress[id] = value;
                document.getElementById(`label-habit-${id}`).textContent = `${value > 0 ? h.subcategories[value - 1] : "Sin empezar"} (${value}/${h.subcategories.length})`;
            });
            slider.addEventListener('change', saveDataToLocalStorage);
        });
    }
    function updateHabitsManagementList() {
        const list = document.getElementById('habits-management-list');
        if (!diaryData.habits?.length) return list.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No hay h√°bitos registrados.</p>';
        list.innerHTML = diaryData.habits.map(h => `<div class="account-item"><div><span style="font-weight: 600;">${h.text}</span><div style="font-size: 0.8em; color: var(--text-secondary);">${h.category || 'Sin categor√≠a'}</div></div><div class="account-actions"><button class="btn-small btn-secondary" data-id="${h.id}" data-action="edit">Editar</button><button class="btn-small btn-danger" data-id="${h.id}" data-action="delete">Eliminar</button></div></div>`).join('');
        list.querySelectorAll('button[data-action]').forEach(btn => btn.addEventListener('click', function() {
            const id = parseInt(this.dataset.id);
            if (this.dataset.action === 'delete') deleteHabit(id); else if (this.dataset.action === 'edit') editHabit(id);
        }));
    }
    
    function updateExpenses() {
      updateAccountsList();
      updateTransactionsList();
      const accounts = diaryData.accounts || [];
      const totalBalance = accounts.reduce((sum, acc) => sum + acc.balance, 0);
      document.getElementById('total-balance').textContent = `$${totalBalance.toFixed(2)}`;
      const mainAccount = accounts.find(acc => acc.isDefault) || accounts[0];
      if (mainAccount) {
        document.getElementById('main-account-balance').textContent = `$${mainAccount.balance.toFixed(2)}`;
        document.getElementById('main-account-name').textContent = mainAccount.name;
      }
    }
    function updateAccountsList() {
        const list = document.getElementById('accounts-list');
        const accounts = diaryData.accounts || [];
        if (!accounts.length) return list.innerHTML = '<p>No hay cuentas</p>';
        list.innerHTML = accounts.map(acc => `
            <div class="account-item ${acc.isDefault ? 'principal' : ''}">
                <div><div style="font-weight: 600;">${acc.name}</div><div class="account-balance">$${acc.balance.toFixed(2)}</div></div>
                <div class="account-actions">
                    <button class="btn-small btn-secondary" data-id="${acc.id}" data-action="edit">Editar</button>
                    ${!acc.isDefault ? `<button class="btn-small btn-success" data-id="${acc.id}" data-action="set-default">Principal</button>` : ''}
                    ${!acc.isDefault ? `<button class="btn-small btn-danger" data-id="${acc.id}" data-action="delete">Eliminar</button>` : ''}
                </div>
            </div>`).join('');
        list.querySelectorAll('button[data-action]').forEach(btn => btn.addEventListener('click', function() {
            const id = parseInt(this.dataset.id);
            if (this.dataset.action === 'edit') editAccount(id);
            else if (this.dataset.action === 'delete') deleteAccount(id);
            else if (this.dataset.action === 'set-default') setDefaultAccount(id);
        }));
        const accountOptions = accounts.map(acc => `<option value="${acc.id}">${acc.name}</option>`).join('');
        document.getElementById('transaction-account').innerHTML = accountOptions;
        document.getElementById('transfer-from').innerHTML = accountOptions;
        document.getElementById('transfer-to').innerHTML = accountOptions;
    }
    function updateTransactionsList() {
        const list = document.getElementById('transactions-list');
        const transactions = diaryData.transactions || [];
        if (!transactions.length) return list.innerHTML = '<li style="justify-content: center;">No hay transacciones</li>';
        const recent = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 15);
        list.innerHTML = recent.map(t => {
            const accName = diaryData.accounts?.find(a => a.id === t.accountId)?.name || 'N/A';
            return `<li><div style="flex-grow: 1;"><div>${t.description}</div><small>${accName} &bull; ${new Date(t.date).toLocaleDateString()}</small></div><div style="color:${t.type === 'income' ? 'var(--success-color)' : 'var(--error-color)'}">${t.type === 'income' ? '+' : '-'}$${t.amount.toFixed(2)}</div></li>`;
        }).join('');
    }
    function addNewTransaction() {
      const amount = parseFloat(document.getElementById('transaction-amount').value);
      const description = document.getElementById('transaction-description').value.trim();
      const accountId = parseInt(document.getElementById('transaction-account').value);
      if (isNaN(amount) || !description || isNaN(accountId)) return showToast('Completa todos los campos');
      const account = diaryData.accounts.find(a => a.id === accountId);
      if (document.getElementById('transaction-type').value === 'income') account.balance += amount; else account.balance -= amount;
      if (!diaryData.transactions) diaryData.transactions = [];
      diaryData.transactions.push({ id: Date.now(), type: document.getElementById('transaction-type').value, amount, description, accountId, date: currentDate });
      document.getElementById('transaction-amount').value = '';
      document.getElementById('transaction-description').value = '';
      updateExpenses();
      saveDataToLocalStorage();
      showToast('Transacci√≥n agregada');
    }
    function addNewAccount() {
      const name = document.getElementById('new-account-name').value.trim();
      if (!name) return showToast('Ingresa un nombre');
      if (!diaryData.accounts) diaryData.accounts = [];
      diaryData.accounts.push({ id: Date.now(), name, balance: parseFloat(document.getElementById('new-account-balance').value) || 0, isDefault: diaryData.accounts.length === 0 });
      document.getElementById('new-account-name').value = '';
      document.getElementById('new-account-balance').value = '0';
      updateExpenses();
      saveDataToLocalStorage();
      showToast('Cuenta agregada');
    }
    function editAccount(accountId) {
      const account = diaryData.accounts.find(a => a.id === accountId);
      if (!account) return;
      editingAccountId = accountId;
      document.getElementById('edit-account-name').value = account.name;
      document.getElementById('edit-account-balance').value = account.balance;
      showModal('edit-account-modal');
    }
    function saveAccountChanges() {
      if (!editingAccountId) return;
      const account = diaryData.accounts.find(a => a.id === editingAccountId);
      const newName = document.getElementById('edit-account-name').value.trim();
      if (!account || !newName) return showToast('Datos inv√°lidos');
      account.name = newName;
      account.balance = parseFloat(document.getElementById('edit-account-balance').value) || 0;
      document.getElementById('edit-account-modal').classList.remove('active');
      updateExpenses();
      saveDataToLocalStorage();
      showToast('Cuenta actualizada');
      editingAccountId = null;
    }
    function deleteAccount(accountId) {
        if (!confirm("¬øSeguro que quieres eliminar esta cuenta?")) return;
        diaryData.accounts = diaryData.accounts.filter(acc => acc.id !== accountId);
        updateExpenses();
        saveDataToLocalStorage();
        showToast("Cuenta eliminada");
    }
    function setDefaultAccount(accountId) {
        diaryData.accounts.forEach(acc => acc.isDefault = (acc.id === accountId));
        updateExpenses();
        saveDataToLocalStorage();
        showToast("Cuenta principal actualizada");
    }
    function transferBetweenAccounts() {
        const fromId = parseInt(document.getElementById('transfer-from').value);
        const toId = parseInt(document.getElementById('transfer-to').value);
        const amount = parseFloat(document.getElementById('transfer-amount').value);
        if (isNaN(fromId) || isNaN(toId) || isNaN(amount) || amount <= 0 || fromId === toId) return showToast('Datos de transferencia inv√°lidos.');
        const fromAccount = diaryData.accounts.find(a => a.id === fromId);
        const toAccount = diaryData.accounts.find(a => a.id === toId);
        if (!fromAccount || !toAccount || fromAccount.balance < amount) return showToast('Fondos insuficientes o cuentas no v√°lidas.');
        fromAccount.balance -= amount;
        toAccount.balance += amount;
        if (!diaryData.transactions) diaryData.transactions = [];
        diaryData.transactions.push({ id: Date.now(), type: 'transfer', amount, description: `Transferencia a ${toAccount.name}`, accountId: fromId, date: currentDate });
        document.getElementById('transfer-amount').value = '';
        updateExpenses();
        saveDataToLocalStorage();
        showToast('Transferencia realizada con √©xito.');
    }
    
    function switchTab(tabId) {
      document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tabId));
      document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
      document.getElementById(`${tabId}-tab`).style.display = 'block';
    }
    function switchTimeFilter(period) {
      document.querySelector('.time-filter.active')?.classList.remove('active');
      document.querySelector(`.time-filter[data-period="${period}"]`)?.classList.add('active');
      updateStats(period);
    }
    
    function updateStats(period = document.querySelector('.time-filter.active').dataset.period) {
        const entries = getEntriesForPeriod(period);
        const transactions = getTransactionsForPeriod(period);
        
        const entriesWithEmotion = entries.filter(e => e.emotion && typeof e.emotion.intensity === 'number');

        if (entriesWithEmotion.length > 0) {
            const totalScore = entriesWithEmotion.reduce((sum, entry) => {
                const emotionData = EMOTIONS.find(em => em.n === entry.emotion.name);
                return sum + (emotionData ? emotionData.v * entry.emotion.intensity : 0);
            }, 0);
            document.getElementById('wellness-index').textContent = (totalScore / entriesWithEmotion.length).toFixed(1);

            const emotionCounts = entriesWithEmotion.reduce((acc, entry) => {
                acc[entry.emotion.name] = (acc[entry.emotion.name] || 0) + 1;
                return acc;
            }, {});
            
            const mainEmotionName = Object.keys(emotionCounts).reduce((a, b) => emotionCounts[a] > emotionCounts[b] ? a : b, 'N/A');
            const mainEmotionData = EMOTIONS.find(em => em.n === mainEmotionName);
            document.getElementById('main-emotion').textContent = mainEmotionData ? mainEmotionData.e : '‚ùì';
            
            updateEmotionChart(entriesWithEmotion);

        } else {
            document.getElementById('wellness-index').textContent = '--';
            document.getElementById('main-emotion').textContent = '--';
            if(emotionChartInstance) { emotionChartInstance.destroy(); emotionChartInstance = null; }
        }
      
        document.getElementById('total-income').textContent = `$${transactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0).toFixed(2)}`;
        document.getElementById('total-expenses').textContent = `$${transactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0).toFixed(2)}`;
        updateExpensesChart(transactions.filter(t => t.type === 'expense'));
        updateBalanceDistributionChart();
        updateHabitsStats(entries);
        updateWellbeingStats(entries);
    }

    function updateHabitsStats(entries) {
        if (!diaryData.habits?.length) {
            document.getElementById('avg-habits-completed').textContent = 'N/A';
            document.getElementById('habits-stats-list').innerHTML = '<li>No hay h√°bitos.</li>';
            return;
        }
        let totalCompletedHabits = 0;
        const habitCompletionCounts = diaryData.habits.reduce((acc, h) => ({ ...acc, [h.id]: 0 }), {});
        entries.forEach(entry => {
            if (entry.habitsProgress) diaryData.habits.forEach(h => {
                if (entry.habitsProgress[h.id] === h.subcategories.length) { totalCompletedHabits++; habitCompletionCounts[h.id]++; }
            });
        });
        document.getElementById('avg-habits-completed').textContent = entries.length > 0 ? (totalCompletedHabits / entries.length).toFixed(1) : '0';
        const performanceList = diaryData.habits.map(h => ({ text: h.text, percentage: entries.length > 0 ? Math.round((habitCompletionCounts[h.id] / entries.length) * 100) : 0 })).sort((a, b) => b.percentage - a.percentage);
        document.getElementById('habits-stats-list').innerHTML = performanceList.map(h => `<li><span>${h.text}</span><span style="color: var(--accent-primary);">${h.percentage}%</span></li>`).join('');
    }
    function updateWellbeingStats(entries) {
        const activityEntries = entries.filter(e => typeof e.physicalActivity === 'number');
        const waterEntries = entries.filter(e => typeof e.waterIntake === 'number');
        document.getElementById('avg-activity').textContent = activityEntries.length ? (activityEntries.reduce((s, e) => s + e.physicalActivity, 0) / activityEntries.length).toFixed(1) : '--';
        document.getElementById('avg-water').textContent = waterEntries.length ? (waterEntries.reduce((s, e) => s + e.waterIntake, 0) / waterEntries.length).toFixed(1) : '--';
    }

    function updateChart(chartInstance, elementId, config) {
        const ctx = document.getElementById(elementId)?.getContext('2d');
        if (!ctx) return null;
        if (chartInstance) chartInstance.destroy();
        return new Chart(ctx, config);
    }
    
    function updateEmotionChart(entries) {
      entries.sort((a, b) => new Date(a.date) - new Date(b.date));
      
      const chartData = entries.map(e => {
          const emotionData = EMOTIONS.find(em => em.n === e.emotion.name);
          const score = emotionData ? emotionData.v * e.emotion.intensity : 0;
          return { x: new Date(e.date + 'T00:00:00'), y: score };
      });

      emotionChartInstance = updateChart(emotionChartInstance, 'emotion-chart', {
        type: 'line', 
        data: {
            datasets: [{ 
                label: '√çndice Bienestar Diario', 
                data: chartData,
                borderColor: 'var(--accent-primary)', 
                backgroundColor: 'var(--accent-primary)',
                tension: 0.4, 
                fill: false 
            }]
        }, 
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'time',
                    time: { unit: 'day', displayFormats: { day: 'd MMM' } },
                    ticks: { color: 'var(--text-secondary)' },
                    grid: { color: 'var(--border-color)' }
                },
                y: {
                    ticks: { color: 'var(--text-secondary)' },
                    grid: { color: 'var(--border-color)' }
                }
            },
            plugins: {
                legend: { labels: { color: 'var(--text-primary)' } }
            }
        }
      });
    }
    
    function updateExpensesChart(transactions) {
      const categories = transactions.reduce((acc, t) => { const cat = t.description.split(' ')[0] || 'Otros'; acc[cat] = (acc[cat] || 0) + t.amount; return acc; }, {});
      expensesChartInstance = updateChart(expensesChartInstance, 'expenses-chart', {
        type: 'doughnut', data: { labels: Object.keys(categories), datasets: [{ data: Object.values(categories), backgroundColor: ['#63b3ed', '#68d391', '#f6ad55', '#fc8181', '#e94560', '#9b59b6'] }] },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }
    function updateBalanceDistributionChart() {
        const accountsWithBalance = (diaryData.accounts || []).filter(a => a.balance > 0);
        balanceChartInstance = updateChart(balanceChartInstance, 'balance-distribution-chart', {
            type: 'doughnut', data: { 
                labels: accountsWithBalance.map(a => a.name), 
                datasets: [{ data: accountsWithBalance.map(a => a.balance), backgroundColor: ['#63b3ed', '#68d391', '#f6ad55', '#fc8181', '#e94560', '#9b59b6'] }] 
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function initCalendar() {
      if (calendarInstance) calendarInstance.destroy();
      calendarInstance = flatpickr("#calendar", {
        inline: true, defaultDate: currentDate, onChange: (selectedDates, dateStr) => loadEntryForDate(dateStr),
        onDayCreate: (dObj, dStr, fp, dayElem) => {
            const date = dayElem.dateObj.toISOString().split('T')[0];
            const entry = diaryData.entries[date];
            if (entry && Object.keys(entry).length) {
                dayElem.classList.add("has-entry");
                const allDone = diaryData.habits?.length > 0 && diaryData.habits.every(h => entry.habitsProgress?.[h.id] === h.subcategories.length);
                if (allDone) dayElem.classList.add("all-habits-done");
            }
        }
      });
    }
    
    function getEntriesForPeriod(period) {
      const now = new Date(); let startDate = new Date();
      if (period === 'week') startDate.setDate(now.getDate() - 7);
      else if (period === 'month') startDate.setMonth(now.getMonth() - 1);
      else if (period === 'year') startDate.setFullYear(now.getFullYear() - 1);
      else startDate = new Date(0);
      return Object.entries(diaryData.entries || {}).filter(([date]) => new Date(date) >= startDate).map(([date, entry]) => ({ ...entry, date }));
    }
    function getTransactionsForPeriod(period) {
        const now = new Date(); let startDate = new Date();
        if (period === 'week') startDate.setDate(now.getDate() - 7);
        else if (period === 'month') startDate.setMonth(now.getMonth() - 1);
        else if (period === 'year') startDate.setFullYear(now.getFullYear() - 1);
        else startDate = new Date(0);
        return (diaryData.transactions || []).filter(t => new Date(t.date) >= startDate && new Date(t.date) <= now);
    }
    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message; toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }
    const debounce = (func, wait) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func(...args), wait); }; };
    function resetDiary() { if (confirm('¬øSeguro? Se borrar√° TODO.')) { localStorage.removeItem('diarioMojiData'); location.reload(); } }
    
    function saveDataToLocalStorage() { if (diaryData.ownerName) localStorage.setItem('diarioMojiData', JSON.stringify(diaryData)); }
    function loadDataFromLocalStorage() {
      const savedData = localStorage.getItem('diarioMojiData');
      if (savedData) {
        diaryData = JSON.parse(savedData);
        if (diaryData.habits?.length && !diaryData.habits[0].subcategories) {
            diaryData.habits.forEach(h => { h.subcategories = [h.text]; });
            Object.values(diaryData.entries).forEach(entry => {
                if (entry.completedHabits) {
                    entry.habitsProgress = {};
                    entry.completedHabits.forEach(id => { const h = diaryData.habits.find(hb => hb.id === id); if(h) entry.habitsProgress[id] = h.subcategories.length; });
                    delete entry.completedHabits;
                }
            });
            saveDataToLocalStorage();
        }
        return true;
      }
      return false;
    }

    function exportDiary() { showToast('Funcionalidad de exportaci√≥n pendiente.'); }
    function handleFileImport(e) { showToast('Funcionalidad de importaci√≥n pendiente.'); }

    initApp();
  });
  </script>
</body>
</html>
