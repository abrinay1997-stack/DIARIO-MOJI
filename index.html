<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#e89595">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>DIARIO MOJI</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  
  <style>
    :root {
      --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      --transition-speed: 0.3s;
      --border-radius: 16px;
      --shadow: 0 2px 12px rgba(0,0,0,0.08);
      --shadow-hover: 0 4px 20px rgba(0,0,0,0.12);
      --container-px: 16px;
      --safe-area-inset-bottom: env(safe-area-inset-bottom, 16px);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: var(--font-family);
      margin: 0;
      padding: 0;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.5;
      font-size: 16px;
      overflow-x: hidden;
      touch-action: manipulation;
    }

    /* Temas optimizados para m√≥vil */
    body.theme-pastel {
      --bg-primary: #fdf6f7;
      --bg-secondary: #ffffff;
      --text-primary: #2d2d2d;
      --text-secondary: #666666;
      --accent-primary: #e89595;
      --accent-secondary: #9cb6c9;
      --border-color: #e4d8dc;
      --success-color: #4caf50;
      --warning-color: #ff9800;
      --error-color: #f44336;
      --card-shadow: 0 2px 12px rgba(232, 149, 149, 0.1);
    }

    body.theme-cream {
      --bg-primary: #fdfaf2;
      --bg-secondary: #ffffff;
      --text-primary: #3c3c3c;
      --text-secondary: #666666;
      --accent-primary: #c89f68;
      --accent-secondary: #a8bba2;
      --border-color: #e7e2d9;
      --success-color: #4caf50;
      --warning-color: #ff9800;
      --error-color: #f44336;
      --card-shadow: 0 2px 12px rgba(200, 159, 104, 0.1);
    }

    body.theme-light {
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --text-primary: #1a202c;
      --text-secondary: #4a5568;
      --accent-primary: #3182ce;
      --accent-secondary: #38a169;
      --border-color: #e2e8f0;
      --success-color: #38a169;
      --warning-color: #ed8936;
      --error-color: #e53e3e;
      --card-shadow: 0 2px 12px rgba(49, 130, 206, 0.1);
    }

    body.theme-dark {
      --bg-primary: #0f0f18;
      --bg-secondary: #1a1a2e;
      --text-primary: #f0f0f0;
      --text-secondary: #a0a0b0;
      --accent-primary: #63b3ed;
      --accent-secondary: #68d391;
      --border-color: #2d3748;
      --success-color: #68d391;
      --warning-color: #f6ad55;
      --error-color: #fc8181;
      --card-shadow: 0 2px 12px rgba(0,0,0,0.3);
    }

    body.theme-vibrant {
      --bg-primary: #0f0f23;
      --bg-secondary: #1a1a2e;
      --text-primary: #ffffff;
      --text-secondary: #c0c0c0;
      --accent-primary: #e94560;
      --accent-secondary: #f39c12;
      --border-color: #333366;
      --success-color: #27ae60;
      --warning-color: #f39c12;
      --error-color: #e74c3c;
      --card-shadow: 0 2px 12px rgba(233, 69, 96, 0.2);
    }

    body.theme-forest {
      --bg-primary: #f0f5f0;
      --bg-secondary: #ffffff;
      --text-primary: #2d4a2d;
      --text-secondary: #5a6e5a;
      --accent-primary: #4a7c59;
      --accent-secondary: #6a994e;
      --border-color: #d8e0d8;
      --success-color: #4caf50;
      --warning-color: #ff9800;
      --error-color: #f44336;
      --card-shadow: 0 2px 12px rgba(74, 124, 89, 0.1);
    }

    body.theme-ocean {
      --bg-primary: #eef7f9;
      --bg-secondary: #ffffff;
      --text-primary: #1e3a4a;
      --text-secondary: #5b8ea7;
      --accent-primary: #3a8a9e;
      --accent-secondary: #5b8ea7;
      --border-color: #d1e3e8;
      --success-color: #4caf50;
      --warning-color: #ff9800;
      --error-color: #f44336;
      --card-shadow: 0 2px 12px rgba(58, 138, 158, 0.1);
    }

    /* Pantallas */
    .screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--bg-primary);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      z-index: 1;
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
    }

    .screen.active {
      opacity: 1;
      pointer-events: auto;
      z-index: 10;
    }

    /* Header m√≥vil optimizado */
    .mobile-header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg-secondary);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border-color);
      padding: 12px var(--container-px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: 60px;
    }

    .mobile-header h1 {
      margin: 0;
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--accent-primary);
    }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    .icon-button {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      font-size: 1.2rem;
      cursor: pointer;
      transition: all var(--transition-speed);
    }

    .icon-button:active {
      transform: scale(0.95);
      background: var(--accent-primary);
      color: white;
    }

    /* Navegaci√≥n inferior FIJA */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-color);
      display: none; /* Oculto por defecto */
      justify-content: space-around;
      padding: 8px var(--container-px) calc(8px + var(--safe-area-inset-bottom));
      z-index: 1000;
      backdrop-filter: blur(10px);
      transform: translateZ(0);
    }
    
    .bottom-nav.visible {
      display: flex; /* Se muestra al a√±adir la clase 'visible' */
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px 12px;
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 0.75rem;
      cursor: pointer;
      transition: all var(--transition-speed);
      border-radius: 12px;
      min-width: 60px;
      flex: 1;
    }

    .nav-item.active {
      color: var(--accent-primary);
      background: var(--bg-primary);
    }

    .nav-icon {
      font-size: 1.3rem;
    }

    /* Contenido principal con padding para navegaci√≥n */
    .main-content {
      padding: 20px var(--container-px) 120px; /* Aumentado padding inferior */
      max-width: 100%;
      overflow-x: hidden;
    }

    /* Widgets m√≥viles */
    .widget {
      background: var(--bg-secondary);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 16px;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow);
      transition: all var(--transition-speed);
    }

    .widget:active {
      transform: scale(0.98);
    }

    .widget h2 {
      margin: 0 0 16px 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 8px;
    }

    /* Selector de emociones mejorado para m√≥vil */
    .emotion-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .emotion-emoji {
      font-size: 2rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      filter: grayscale(80%) brightness(0.8);
      opacity: 0.7;
      padding: 8px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      background: var(--bg-primary);
      aspect-ratio: 1;
    }

    .emotion-emoji.selected {
      filter: grayscale(0%) brightness(1);
      opacity: 1;
      transform: scale(1.15);
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }

    /* Slider de intensidad mejorado */
    .intensity-slider-container {
      background: var(--bg-primary);
      padding: 16px;
      border-radius: var(--border-radius);
      margin-top: 16px;
    }

    #emotion-intensity {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: linear-gradient(to right, var(--error-color), var(--warning-color), var(--success-color));
      outline: none;
      -webkit-appearance: none;
      margin: 8px 0;
    }

    #emotion-intensity::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      cursor: pointer;
      border: 2px solid var(--accent-primary);
    }

    /* Acordeones para secciones desplegables */
    .accordion {
      margin-bottom: 16px;
      border-radius: var(--border-radius);
      overflow: hidden;
      border: 1px solid var(--border-color);
    }

    .accordion-header {
      background: var(--bg-secondary);
      padding: 16px 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      transition: all var(--transition-speed);
    }

    .accordion-header:active {
      background: var(--bg-primary);
    }

    .accordion-header::after {
      content: '‚ñº';
      font-size: 0.8rem;
      transition: transform var(--transition-speed);
    }

    .accordion-header.active::after {
      transform: rotate(180deg);
    }

    .accordion-content {
      background: var(--bg-primary);
      max-height: 0;
      overflow: hidden;
      transition: max-height var(--transition-speed);
    }

    .accordion-content.active {
      max-height: 1000px;
      padding: 20px;
    }

    /* Editor moderno */
    .editor-container {
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius);
      overflow: hidden;
      background: var(--bg-primary);
    }

    .editor-toolbar {
      display: flex;
      overflow-x: auto;
      gap: 8px;
      padding: 12px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .editor-toolbar::-webkit-scrollbar {
      display: none;
    }

    .editor-toolbar button {
      padding: 10px 14px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      cursor: pointer;
      transition: all var(--transition-speed);
      font-weight: 600;
      min-width: 44px;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .editor-toolbar button:active {
      background: var(--accent-primary);
      color: white;
      transform: scale(0.95);
    }

    #editor {
      min-height: 200px;
      padding: 16px;
      font-size: 16px;
      line-height: 1.6;
      outline: none;
    }

    #editor:empty:before {
      content: attr(placeholder);
      color: var(--text-secondary);
    }

    /* Listas t√°ctiles */
    .touch-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 200px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .touch-list li {
      display: flex;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid var(--border-color);
      transition: background-color var(--transition-speed);
      min-height: 52px;
    }

    .touch-list li:active {
      background-color: var(--bg-primary);
    }

    .touch-list input {
      margin-right: 14px;
      transform: scale(1.3);
      min-width: 20px;
      min-height: 20px;
    }

    .touch-list label {
      flex-grow: 1;
      cursor: pointer;
    }

    /* Estilos para el nuevo slider de h√°bitos */
    .habit-item {
        padding: 14px 0;
        border-bottom: 1px solid var(--border-color);
    }
    .habit-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .habit-title {
        font-weight: 600;
    }
    .habit-category {
        font-size: 0.8em;
        color: var(--text-secondary);
        background-color: var(--bg-primary);
        padding: 2px 8px;
        border-radius: 8px;
    }
    .habit-slider {
        width: 100%;
    }
    .habit-subcategory-label {
        text-align: center;
        margin-top: 8px;
        font-size: 0.9em;
        color: var(--accent-primary);
        font-weight: 500;
        min-height: 1.2em;
    }

    /* Botones m√≥viles */
    .btn-primary {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white;
      border: none;
      padding: 16px 24px;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all var(--transition-speed);
      font-weight: 600;
      font-size: 1rem;
      width: 100%;
      min-height: 52px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary:active {
      transform: scale(0.98);
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    /* Modales m√≥viles */
    .modal {
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      z-index: 2000;
    }

    .modal-content {
      background: var(--bg-secondary);
      margin: 20px;
      border-radius: var(--border-radius);
      padding: 20px;
      max-height: calc(100vh - 100px);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      position: relative;
      animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg-primary);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.2rem;
      color: var(--text-secondary);
      z-index: 1;
    }

    /* Pesta√±as m√≥viles */
    .tabs {
      display: flex;
      flex-wrap: wrap; 
      gap: 8px;
      margin-bottom: 20px;
      justify-content: center;
    }

    .tab {
      padding: 12px 20px;
      background: var(--bg-primary);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all var(--transition-speed);
      white-space: nowrap;
      font-weight: 600;
      color: var(--text-secondary);
      min-height: 44px;
    }

    .tab.active {
      background: var(--accent-primary);
      color: white;
    }

    /* Mejoras de accesibilidad m√≥vil */
    @media (max-width: 480px) {
      .widget {
        padding: 16px;
        margin-bottom: 12px;
      }
      
      .main-content {
        padding: 16px 16px 120px;
      }
      
      .mobile-header {
        padding: 12px 16px;
      }
    }

    /* Soporte para dispositivos muy peque√±os */
    @media (max-width: 360px) {
      :root {
        --container-px: 12px;
      }
      
      .emotion-selector {
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
      }
      
      .emotion-emoji {
        font-size: 1.8rem;
      }
    }

    /* Estados de carga */
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }

    .skeleton {
      background: linear-gradient(90deg, var(--bg-primary) 25%, var(--border-color) 50%, var(--bg-primary) 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      border-radius: var(--border-radius);
    }

    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* Toast m√≥vil */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--bg-secondary);
      color: var(--text-primary);
      padding: 12px 20px;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      z-index: 10000;
      transition: all 0.3s ease;
      border: 1px solid var(--border-color);
      max-width: 90%;
      text-align: center;
      opacity: 0;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* Calendario mejorado */
    .calendar-container {
      background: var(--bg-primary);
      border-radius: var(--border-radius);
      padding: 16px;
    }

    .flatpickr-calendar {
      border-radius: var(--border-radius) !important;
      box-shadow: var(--shadow) !important;
      width: 100% !important;
    }

    .flatpickr-day {
      min-height: 40px !important;
      min-width: 40px !important;
      line-height: 40px !important;
    }

    .flatpickr-day.has-entry {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)) !important;
      color: white !important;
      border-radius: 50% !important;
      font-weight: 600 !important;
    }

    .flatpickr-day.today {
      border: 2px solid var(--accent-primary) !important;
    }

    /* Gesti√≥n de cuentas */
    .account-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .account-item.principal {
      background-color: var(--bg-primary);
      border-radius: var(--border-radius);
      padding: 14px;
      margin: 8px 0;
      border: 2px solid var(--accent-primary);
    }

    .account-balance {
      font-weight: 600;
      color: var(--accent-primary);
    }

    .account-actions {
      display: flex;
      gap: 8px;
    }

    .btn-small {
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .btn-danger {
      background: var(--error-color);
      color: white;
    }

    .btn-success {
      background: var(--success-color);
      color: white;
    }

    .btn-secondary {
      background: var(--bg-primary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .btn-disabled {
      background: var(--border-color);
      color: var(--text-secondary);
      cursor: not-allowed;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius);
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 1rem;
    }

    .recurring-options {
      background: var(--bg-primary);
      padding: 16px;
      border-radius: var(--border-radius);
      margin-top: 16px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    
    .stat-card {
      background: var(--bg-primary);
      border-radius: var(--border-radius);
      padding: 20px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      margin: 10px 0;
    }
    
    .stat-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    /* Filtros de tiempo */
    .time-filters {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      overflow-x: auto;
      padding-bottom: 8px;
    }

    .time-filter {
      padding: 10px 16px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .time-filter.active {
      background: var(--accent-primary);
      color: white;
      border-color: var(--accent-primary);
    }

    /* Gr√°ficos */
    .chart-container {
      height: 300px;
      position: relative;
      margin: 16px 0;
    }
  </style>
</head>
<body class="theme-pastel">
  <!-- PANTALLA DE BIENVENIDA -->
  <div id="welcome-screen" class="screen active">
    <div class="main-content" style="display: flex; align-items: center; justify-content: center; min-height: 100vh;">
      <div class="widget" style="text-align: center; max-width: 400px;">
        <h1 style="font-size: 2.5rem; margin-bottom: 16px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">üìî DIARIO MOJI</h1>
        <p style="color: var(--text-secondary); margin-bottom: 32px; font-size: 1.1rem;">
          Tu espacio personal para reflexionar y crecer
        </p>
        <div style="display: flex; flex-direction: column; gap: 16px;">
          <button class="btn-primary" id="btn-new-diary">
            <span>üìù</span> Crear Nuevo Diario
          </button>
          <button class="btn-primary" id="btn-open-diary">
            <span>üìÇ</span> Abrir Diario Existente
          </button>
        </div>
        <input type="file" id="import-file-input" accept=".xml" style="display: none;">
      </div>
    </div>
  </div>

  <!-- PANTALLA DE NOMBRE -->
  <div id="name-prompt-screen" class="screen">
    <div class="mobile-header">
      <button class="icon-button" id="btn-back-name">‚Üê</button>
      <h1>Nuevo Diario</h1>
      <div style="width: 44px;"></div> </div>
    <div class="main-content">
      <div class="widget" style="text-align: center;">
        <h2>¬øC√≥mo te llamas?</h2>
        <p style="color: var(--text-secondary); margin-bottom: 24px;">
          Este nombre se usar√° como t√≠tulo de tu diario
        </p>
        <input type="text" id="owner-name-input" placeholder="Escribe tu nombre..." 
               style="width: 100%; padding: 16px; border: 2px solid var(--border-color); border-radius: var(--border-radius); background: var(--bg-primary); color: var(--text-primary); font-size: 1.1rem; margin-bottom: 24px;">
        <button class="btn-primary" id="btn-confirm-name">Continuar</button>
      </div>
    </div>
  </div>

  <!-- PANTALLA PRINCIPAL DEL DIARIO -->
  <div id="main-diary-screen" class="screen">
    <div class="mobile-header">
      <h1 id="diary-owner-name">Mi Diario</h1>
      <button class="icon-button" id="btn-calendar-header">üìÖ</button>
      <div class="header-actions">
        <button class="icon-button" id="btn-save" title="Guardar">üíæ</button>
        <button class="icon-button" id="btn-settings" title="Ajustes">‚öôÔ∏è</button>
      </div>
    </div>

    <div class="main-content">
      <div class="widget">
        <h2 id="emotion-date-label">C√≥mo te sientes hoy</h2>
        <div class="emotion-selector" id="emotion-selector">
          </div>
        <div class="intensity-slider-container">
          <label for="emotion-intensity" style="display: block; margin-bottom: 8px; font-weight: 600;">
            Intensidad: <span id="intensity-value">5</span>/10
          </label>
          <input type="range" id="emotion-intensity" min="1" max="10" value="5">
        </div>
      </div>

      <div class="accordion">
        <div class="accordion-header">Mi Entrada de Hoy</div>
        <div class="accordion-content">
          <div class="editor-container">
            <div class="editor-toolbar">
              <button data-command="bold" title="Negrita"><b>B</b></button>
              <button data-command="italic" title="Cursiva"><i>I</i></button>
              <button data-command="underline" title="Subrayado"><u>U</u></button>
              <button data-command="insertUnorderedList" title="Lista">‚Ä¢</button>
              <button id="btn-emoji" title="Emojis">üòÄ</button>
            </div>
            <div id="emoji-picker" style="display: none; background: var(--bg-primary); padding: 16px; border-radius: var(--border-radius); margin-bottom: 16px; grid-template-columns: repeat(6, 1fr); gap: 8px;"></div>
            <div id="editor" contenteditable="true" placeholder="Escribe sobre tu d√≠a..."></div>
          </div>
        </div>
      </div>

      <div class="accordion">
        <div class="accordion-header">H√°bitos de Hoy</div>
        <div class="accordion-content">
          <div id="habits-list"></div>
        </div>
      </div>

      <div class="accordion">
        <div class="accordion-header">Mi Bienestar</div>
        <div class="accordion-content">
          <div style="display: flex; flex-direction: column; gap: 20px;">
            <div>
              <label for="physical-activity" style="display: block; margin-bottom: 8px; font-weight: 600;">
                Actividad F√≠sica: <span id="physical-activity-value">5</span>/10
              </label>
              <input type="range" id="physical-activity" min="1" max="10" value="5" style="width: 100%;">
            </div>
            <div>
              <label for="water-intake" style="display: block; margin-bottom: 8px; font-weight: 600;">
                Vasos de Agua: <span id="water-intake-value">0</span>
              </label>
              <input type="range" id="water-intake" min="0" max="12" value="0" style="width: 100%;">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PANTALLA DE H√ÅBITOS (NUEVO) -->
  <div id="habitos-screen" class="screen">
    <div class="mobile-header">
      <button class="icon-button" id="btn-habitos-back">‚Üê</button>
      <h1>H√°bitos</h1>
      <div style="width: 44px;"></div>
    </div>
    <div class="main-content">
        <div class="widget">
            <h2>Mis H√°bitos</h2>
            <div id="habits-management-list">
                <p style="text-align: center; color: var(--text-secondary);">No hay h√°bitos registrados</p>
            </div>
        </div>
        <div class="widget">
            <h2>Agregar Nuevo H√°bito</h2>
            <div class="form-group">
                <label for="new-habit-name">Nombre del H√°bito:</label>
                <input type="text" id="new-habit-name" placeholder="Ej: Rutina de ma√±ana">
            </div>
            <div class="form-group">
                <label for="new-habit-category">Categor√≠a:</label>
                <input type="text" id="new-habit-category" placeholder="Ej: Bienestar, Productividad">
            </div>
            <div class="form-group">
                <label for="new-habit-subcategories">Subcategor√≠as (separadas por coma):</label>
                <textarea id="new-habit-subcategories" rows="3" placeholder="Ej: Tender la cama, Meditar, Beber agua"></textarea>
            </div>
            <button class="btn-primary" id="btn-add-habit">
                <span>‚ûï</span> Agregar H√°bito
            </button>
        </div>
    </div>
  </div>

  <!-- PANTALLA DE CALENDARIO -->
  <div id="calendar-screen" class="screen">
    <div class="mobile-header">
      <button class="icon-button" id="btn-calendar-back">‚Üê</button>
      <h1>Calendario</h1>
      <div style="width: 44px;"></div> </div>
    <div class="main-content">
      <div class="widget">
        <h2>Selecciona una fecha</h2>
        <div class="calendar-container">
          <div id="calendar"></div>
        </div>
      </div>
      <div class="widget">
        <h2>Resumen del d√≠a</h2>
        <div id="day-summary">
          <p style="text-align: center; color: var(--text-secondary);">Selecciona una fecha para ver el resumen</p>
        </div>
      </div>
    </div>
  </div>

  <!-- PANTALLA DE GASTOS -->
  <div id="expenses-screen" class="screen">
    <div class="mobile-header">
      <button class="icon-button" id="btn-expenses-back">‚Üê</button>
      <h1>Gastos</h1>
      <div style="width: 44px;"></div> </div>
    <div class="main-content">
      <div class="widget">
        <h2>Resumen Financiero</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Balance Total</div>
            <div class="stat-value" id="total-balance">$0</div>
            <div class="stat-label">Todas las cuentas</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Cuenta Principal</div>
            <div class="stat-value" id="main-account-balance">$0</div>
            <div class="stat-label" id="main-account-name">Cuenta Principal</div>
          </div>
        </div>
      </div>
      
      <div class="accordion">
        <div class="accordion-header">Registrar Transacci√≥n</div>
        <div class="accordion-content">
          <div class="form-group">
            <label for="transaction-type">Tipo:</label>
            <select id="transaction-type">
              <option value="expense">Gasto</option>
              <option value="income">Ingreso</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="transaction-amount">Monto:</label>
            <input type="number" id="transaction-amount" step="0.01" placeholder="0.00">
          </div>
          
          <div class="form-group">
            <label for="transaction-description">Descripci√≥n:</label>
            <input type="text" id="transaction-description" placeholder="Descripci√≥n de la transacci√≥n">
          </div>
          
          <div class="form-group">
            <label for="transaction-account">Cuenta:</label>
            <select id="transaction-account"></select>
          </div>
          
          <div class="form-group">
            <label for="transaction-recurring">¬øEs recurrente?</label>
            <select id="transaction-recurring">
              <option value="none">No</option>
              <option value="daily">Diario</option>
              <option value="weekly">Semanal</option>
              <option value="monthly">Mensual</option>
              <option value="yearly">Anual</option>
            </select>
          </div>
          
          <div id="recurring-options" class="recurring-options" style="display: none;">
            <div class="form-group">
              <label for="recurring-start-date">Fecha de inicio:</label>
              <input type="date" id="recurring-start-date">
            </div>
            <div class="form-group">
              <label for="recurring-end-date">Fecha de fin (opcional):</label>
              <input type="date" id="recurring-end-date">
            </div>
          </div>
          
          <button class="btn-primary" id="btn-add-transaction">Agregar Transacci√≥n</button>
        </div>
      </div>
      
      <div class="accordion">
        <div class="accordion-header">Gesti√≥n de Cuentas</div>
        <div class="accordion-content">
          <div id="accounts-list">
            <p style="text-align: center; color: var(--text-secondary);">No hay cuentas registradas</p>
          </div>
          
          <div class="form-group" style="margin-top: 20px;">
            <label for="new-account-name">Nueva Cuenta:</label>
            <input type="text" id="new-account-name" placeholder="Nombre de la cuenta">
          </div>
          
          <div class="form-group">
            <label for="new-account-balance">Saldo inicial:</label>
            <input type="number" id="new-account-balance" step="0.01" value="0">
          </div>
          
          <button class="btn-primary" id="btn-add-account">Agregar Cuenta</button>
          
          <div class="form-group" style="margin-top: 20px;">
            <label for="transfer-from">Transferencia entre cuentas:</label>
            <select id="transfer-from">
              <option value="">Desde cuenta...</option>
            </select>
          </div>
          
          <div class="form-group">
            <select id="transfer-to">
              <option value="">Hacia cuenta...</option>
            </select>
          </div>
          
          <div class="form-group">
            <input type="number" id="transfer-amount" step="0.01" placeholder="Monto a transferir">
          </div>
          
          <button class="btn-primary" id="btn-transfer">Realizar Transferencia</button>
        </div>
      </div>
      
      <div class="accordion">
        <div class="accordion-header">√öltimas Transacciones</div>
        <div class="accordion-content">
          <ul class="touch-list" id="transactions-list"></ul>
        </div>
      </div>
    </div>
  </div>
  
  <!-- PANTALLA DE ESTAD√çSTICAS -->
  <div id="stats-screen" class="screen">
    <div class="mobile-header">
      <button class="icon-button" id="btn-stats-back">‚Üê</button>
      <h1>Estad√≠sticas</h1>
      <div style="width: 44px;"></div> </div>
    <div class="main-content">
      <div class="time-filters">
        <button class="time-filter active" data-period="week">Semana</button>
        <button class="time-filter" data-period="month">Mes</button>
        <button class="time-filter" data-period="year">A√±o</button>
        <button class="time-filter" data-period="all">Todo</button>
      </div>
      
      <div class="tabs">
        <button class="tab active" data-tab="emociones">Emociones</button>
        <button class="tab" data-tab="finanzas">Finanzas</button>
        <button class="tab" data-tab="habitos">H√°bitos</button>
        <button class="tab" data-tab="bienestar">Bienestar</button>
      </div>
      
      <div id="emociones-tab" class="tab-content">
        <div class="widget">
          <h2>Resumen Emocional</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">√çndice de Bienestar</div>
              <div class="stat-value" id="wellness-index">--</div>
              <div class="stat-label">Promedio del per√≠odo</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Emoci√≥n Principal</div>
              <div class="stat-value" id="main-emotion">--</div>
              <div class="stat-label">M√°s frecuente</div>
            </div>
          </div>
        </div>
        
        <div class="widget">
          <h2>Evoluci√≥n Emocional</h2>
          <div class="chart-container">
            <canvas id="emotion-chart"></canvas>
            <div id="emotion-chart-no-data" style="display: none; text-align: center; color: var(--text-secondary); padding: 2em;">
              No hay datos para mostrar el gr√°fico.
            </div>
          </div>
        </div>
      </div>
      
      <div id="finanzas-tab" class="tab-content" style="display: none;">
        <div class="widget">
          <h2>Resumen Financiero</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Ingresos</div>
              <div class="stat-value" id="total-income">$0</div>
              <div class="stat-label">Total del per√≠odo</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Gastos</div>
              <div class="stat-value" id="total-expenses">$0</div>
              <div class="stat-label">Total del per√≠odo</div>
            </div>
          </div>
        </div>

        <div class="widget">
          <h2>Distribuci√≥n del Balance Total</h2>
          <div class="chart-container">
            <canvas id="balance-distribution-chart"></canvas>
          </div>
        </div>

        <div class="widget">
          <h2>Distribuci√≥n de Gastos</h2>
          <div class="chart-container">
            <canvas id="expenses-chart"></canvas>
          </div>
        </div>
        
        <div class="widget">
          <h2>Evoluci√≥n Financiera</h2>
          <div class="chart-container">
            <canvas id="finance-trend-chart"></canvas>
          </div>
        </div>
      </div>
      
      <div id="habitos-tab" class="tab-content" style="display: none;">
        <div class="widget">
          <h2>H√°bitos m√°s Cumplidos</h2>
          <ul class="touch-list" id="habits-stats-list"></ul>
        </div>
      </div>
      
      <div id="bienestar-tab" class="tab-content" style="display: none;">
        <div class="widget">
          <h2>Estad√≠sticas de Bienestar</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Actividad F√≠sica Promedio</div>
              <div class="stat-value" id="avg-activity">--</div>
              <div class="stat-label">Intensidad (1-10)</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Agua Promedio</div>
              <div class="stat-value" id="avg-water">--</div>
              <div class="stat-label">Vasos por d√≠a</div>
            </div>
          </div>
        </div>
        
        <div class="widget">
          <h2>Evoluci√≥n del Bienestar</h2>
          <div class="chart-container">
            <canvas id="wellbeing-chart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL DE AJUSTES -->
  <div id="settings-modal" class="modal screen">
    <div class="modal-content">
      <button class="close-btn">&times;</button>
      <h2 style="margin-bottom: 24px;">Ajustes</h2>
      
      <div class="widget" style="margin-bottom: 16px;">
        <h3>Nombre del Diario</h3>
        <input type="text" id="diary-name-input" placeholder="Nombre del diario" 
               style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: var(--border-radius); background: var(--bg-primary); color: var(--text-primary);">
      </div>
      
      <div class="widget" style="margin-bottom: 16px;">
        <h3>Tema Visual</h3>
        <select id="theme-selector" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: var(--border-radius); background: var(--bg-primary); color: var(--text-primary);">
          <option value="pastel">Pastel</option>
          <option value="cream">Crema</option>
          <option value="light">Claro</option>
          <option value="dark">Oscuro</option>
          <option value="vibrant">Vibrante</option>
          <option value="forest">Bosque</option>
          <option value="ocean">Oc√©ano</option>
        </select>
      </div>
      
      <div class="widget" style="margin-bottom: 16px;">
        <h3>Seguridad</h3>
        <input type="password" id="password-input" placeholder="Contrase√±a opcional" 
               style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: var(--border-radius); background: var(--bg-primary); color: var(--text-primary); margin-bottom: 12px;">
        <small style="color: var(--text-secondary);">Se guarda en el archivo XML</small>
      </div>
      
      <button class="btn-primary" id="btn-save-settings" style="margin-top: 16px;">Guardar Cambios</button>

      <button class="btn-primary btn-danger" id="btn-reset-diary" style="margin-top: 12px; background: var(--error-color);">
        Resetear Diario
      </button>
    </div>
  </div>

  <!-- MODAL PARA EDITAR H√ÅBITO (NUEVO) -->
  <div id="edit-habit-modal" class="modal screen">
    <div class="modal-content">
        <button class="close-btn">&times;</button>
        <h2 style="margin-bottom: 24px;">Editar H√°bito</h2>
        <div class="widget">
            <div class="form-group">
                <label for="edit-habit-name">Nombre del H√°bito:</label>
                <input type="text" id="edit-habit-name">
            </div>
            <div class="form-group">
                <label for="edit-habit-category">Categor√≠a:</label>
                <input type="text" id="edit-habit-category">
            </div>
            <div class="form-group">
                <label for="edit-habit-subcategories">Subcategor√≠as (separadas por coma):</label>
                <textarea id="edit-habit-subcategories" rows="3"></textarea>
            </div>
            <button class="btn-primary" id="btn-save-habit">Guardar Cambios</button>
        </div>
    </div>
  </div>

  <!-- MODAL PARA EDITAR CUENTA -->
  <div id="edit-account-modal" class="modal screen">
    <div class="modal-content">
      <button class="close-btn">&times;</button>
      <h2 style="margin-bottom: 24px;">Editar Cuenta</h2>
      
      <div class="widget">
        <div class="form-group">
          <label for="edit-account-name">Nombre de la cuenta:</label>
          <input type="text" id="edit-account-name" placeholder="Nombre de la cuenta">
        </div>
        
        <div class="form-group">
          <label for="edit-account-balance">Saldo actual:</label>
          <input type="number" id="edit-account-balance" step="0.01" placeholder="0.00">
        </div>
        
        <button class="btn-primary" id="btn-save-account">Guardar Cambios</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- MEN√ö DE NAVEGACI√ìN INFERIOR (ACTUALIZADO) -->
  <nav class="bottom-nav">
    <button class="nav-item active" data-screen="diario">
      <span class="nav-icon">üìî</span>
      <span>Diario</span>
    </button>
    <button class="nav-item" data-screen="habitos">
      <span class="nav-icon">üìã</span>
      <span>H√°bitos</span>
    </button>
    <button class="nav-item" data-screen="gastos">
      <span class="nav-icon">üí∞</span>
      <span>Gastos</span>
    </button>
    <button class="nav-item" data-screen="estadisticas">
      <span class="nav-icon">üìä</span>
      <span>Estad√≠sticas</span>
    </button>
  </nav>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Variables globales
    let diaryData = {};
    let currentDate = new Date().toISOString().split('T')[0];
    let calendarInstance = null;
    let emotionChartInstance = null;
    let expensesChartInstance = null;
    let financeTrendChartInstance = null;
    let wellbeingChartInstance = null;
    let balanceChartInstance = null;
    let currentStatsPeriod = 'week';
    let editingAccountId = null;
    let editingHabitId = null;

    // Datos de configuraci√≥n
    const EMOTIONS = [
      {e:'üòÑ', n:'Alegr√≠a', v:2}, {e:'üòä', n:'Calma', v:1}, {e:'üòê', n:'Neutral', v:0},
      {e:'üòü', n:'Ansiedad', v:-1}, {e:'üò≠', n:'Tristeza', v:-2}, {e:'üò†', n:'Enojo', v:-2},
      {e:'üò±', n:'Miedo', v:-1}, {e:'üòç', n:'Amor', v:2}, {e:'ü§î', n:'Reflexi√≥n', v:0},
      {e:'üò¥', n:'Cansancio', v:-1}
    ];

    const EMOJI_LIST = ['üòÄ', 'üòÇ', 'üòä', 'üòç', 'ü§î', 'üò¢', 'üò†', 'üëç', 'üëé', '‚ù§Ô∏è', 'üî•', 'üéâ', '‚ú®', 'üí°', 'üôè'];

    // Inicializaci√≥n de la aplicaci√≥n
    function initApp() {
      setupEventListeners();
      renderEmotionSelector();
      setupEditor();
      setupAccordions();

      if (loadDataFromLocalStorage()) {
        document.getElementById('diary-owner-name').textContent = `Diario de ${diaryData.ownerName}`;
        document.body.className = `theme-${diaryData.settings.theme || 'pastel'}`;
        document.querySelector('.bottom-nav').classList.add('visible');
        showScreen('main-diary-screen');
        switchBottomNav('diario');
        loadEntryForDate(currentDate);

        updateHabitsList();
        updateHabitsManagementList();
        updateExpenses();
        showToast(`¬°Bienvenido/a de nuevo, ${diaryData.ownerName}!`);
      } else {
        showScreen('welcome-screen');
      }
    }

    // Configurar event listeners
    function setupEventListeners() {
      document.getElementById('btn-new-diary').addEventListener('click', () => showScreen('name-prompt-screen'));
      document.getElementById('btn-open-diary').addEventListener('click', () => document.getElementById('import-file-input').click());
      document.getElementById('btn-confirm-name').addEventListener('click', createNewDiary);
      document.getElementById('btn-back-name').addEventListener('click', () => showScreen('welcome-screen'));
      document.getElementById('btn-reset-diary').addEventListener('click', resetDiary);
      
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', (e) => {
          const screen = e.currentTarget.dataset.screen;
          switchBottomNav(screen);
        });
      });
      
      document.getElementById('btn-calendar-back').addEventListener('click', () => switchBottomNav('diario'));
      document.getElementById('btn-habitos-back').addEventListener('click', () => switchBottomNav('diario'));
      document.getElementById('btn-stats-back').addEventListener('click', () => switchBottomNav('diario'));
      document.getElementById('btn-expenses-back').addEventListener('click', () => switchBottomNav('diario'));
      document.getElementById('btn-calendar-header').addEventListener('click', () => switchBottomNav('calendario'));
      
      document.getElementById('emotion-intensity').addEventListener('input', (e) => {
        document.getElementById('intensity-value').textContent = e.target.value;
        saveEmotionData();
      });
      
      document.getElementById('physical-activity').addEventListener('input', (e) => {
        document.getElementById('physical-activity-value').textContent = e.target.value;
        saveWellbeingData();
      });
      
      document.getElementById('water-intake').addEventListener('input', (e) => {
        document.getElementById('water-intake-value').textContent = e.target.value;
        saveWellbeingData();
      });
      
      document.getElementById('editor').addEventListener('input', debounce(saveEntryText, 500));
      
      document.getElementById('btn-save').addEventListener('click', exportDiary);
      document.getElementById('btn-settings').addEventListener('click', () => showModal('settings-modal'));
      
      document.getElementById('btn-save-settings').addEventListener('click', saveSettings);
      
      document.getElementById('btn-add-habit').addEventListener('click', addNewHabit);
      document.getElementById('btn-save-habit').addEventListener('click', saveHabitChanges);
      
      document.getElementById('btn-add-transaction').addEventListener('click', addNewTransaction);
      document.getElementById('btn-add-account').addEventListener('click', addNewAccount);
      document.getElementById('btn-transfer').addEventListener('click', transferBetweenAccounts);
      document.getElementById('transaction-recurring').addEventListener('change', toggleRecurringOptions);
      document.getElementById('btn-save-account').addEventListener('click', saveAccountChanges);
      
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', (e) => switchTab(e.currentTarget.dataset.tab));
      });
      
      document.querySelectorAll('.time-filter').forEach(filter => {
        filter.addEventListener('click', (e) => switchTimeFilter(e.currentTarget.dataset.period));
      });
      
      document.querySelectorAll('.close-btn').forEach(btn => {
        btn.addEventListener('click', (e) => e.target.closest('.modal').classList.remove('active'));
      });
      
      document.getElementById('import-file-input').addEventListener('change', handleFileImport);
    }

    function setupAccordions() {
      document.querySelectorAll('.accordion-header').forEach(header => {
        header.addEventListener('click', () => {
          header.classList.toggle('active');
          header.nextElementSibling.classList.toggle('active');
        });
      });
    }

    function renderEmotionSelector() {
      const container = document.getElementById('emotion-selector');
      container.innerHTML = EMOTIONS.map(emotion => `
        <div class="emotion-emoji" data-name="${emotion.n}" title="${emotion.n}">${emotion.e}</div>
      `).join('');
      
      container.addEventListener('click', (e) => {
        const target = e.target.closest('.emotion-emoji');
        if (target) {
          document.querySelectorAll('.emotion-emoji').forEach(el => el.classList.remove('selected'));
          target.classList.add('selected');
          saveEmotionData();
        }
      });
    }

    function setupEditor() {
      const editor = document.getElementById('editor');
      const toolbar = document.querySelector('.editor-toolbar');
      const emojiPicker = document.getElementById('emoji-picker');
      
      toolbar.addEventListener('click', (e) => {
        const button = e.target.closest('button');
        if (button) {
          if (button.id === 'btn-emoji') {
            emojiPicker.style.display = emojiPicker.style.display === 'grid' ? 'none' : 'grid';
          } else {
            document.execCommand(button.dataset.command, false, null);
            editor.focus();
          }
        }
      });
      
      emojiPicker.innerHTML = EMOJI_LIST.map(emoji => `<span style="font-size: 1.5rem; cursor: pointer; text-align: center;">${emoji}</span>`).join('');
      emojiPicker.addEventListener('click', (e) => {
        if (e.target.tagName === 'SPAN') {
          editor.focus();
          document.execCommand('insertText', false, e.target.textContent);
        }
      });
    }

    function switchBottomNav(screen) {
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.screen === screen);
      });
      
      const mainScreens = ['main-diary-screen', 'habitos-screen', 'calendar-screen', 'expenses-screen', 'stats-screen'];
      mainScreens.forEach(screenId => {
        const screenEl = document.getElementById(screenId);
        if (screenEl) screenEl.classList.remove('active');
      });

      let screenIdToShow = '';
      if (screen === 'diario') screenIdToShow = 'main-diary-screen';
      else if (screen === 'habitos') {
        screenIdToShow = 'habitos-screen';
        updateHabitsManagementList();
      } else if (screen === 'gastos') {
        screenIdToShow = 'expenses-screen';
        updateExpenses();
      } else if (screen === 'estadisticas') {
        screenIdToShow = 'stats-screen';
        updateStats();
      } else if (screen === 'calendario') {
        screenIdToShow = 'calendar-screen';
        initCalendar();
      }
      
      const targetScreen = document.getElementById(screenIdToShow);
      if(targetScreen) targetScreen.classList.add('active');
    }

    function switchTab(tabId) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.toggle('active', tab.dataset.tab === tabId));
      document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
      document.getElementById(`${tabId}-tab`).style.display = 'block';
      if (tabId === 'finanzas') updateFinanceCharts();
      else if (tabId === 'bienestar') updateWellbeingChart();
    }

    function switchTimeFilter(period) {
      currentStatsPeriod = period;
      document.querySelectorAll('.time-filter').forEach(filter => filter.classList.toggle('active', filter.dataset.period === period));
      updateStats();
    }

    function initCalendar() {
      if (calendarInstance) calendarInstance.destroy();
      calendarInstance = flatpickr("#calendar", {
        inline: true,
        defaultDate: currentDate,
        onChange: (selectedDates, dateStr) => {
          currentDate = dateStr;
          loadEntryForDate(currentDate);
          updateDaySummary(dateStr);
        },
        onDayCreate: (dObj, dStr, fp, dayElem) => {
          const date = dayElem.dateObj.toISOString().split('T')[0];
          if (diaryData.entries[date] && Object.keys(diaryData.entries[date]).length > 0) {
            dayElem.classList.add("has-entry");
          }
        }
      });
      updateDaySummary(currentDate);
    }

    function loadEntryForDate(date) {
      const entry = diaryData.entries[date] || {};
      
      document.querySelectorAll('.emotion-emoji.selected').forEach(el => el.classList.remove('selected'));
      if (entry.emotion) {
        const emotionElement = document.querySelector(`.emotion-emoji[data-name="${entry.emotion.name}"]`);
        if (emotionElement) emotionElement.classList.add('selected');
        document.getElementById('emotion-intensity').value = entry.emotion.intensity;
        document.getElementById('intensity-value').textContent = entry.emotion.intensity;
      } else {
        document.getElementById('emotion-intensity').value = 5;
        document.getElementById('intensity-value').textContent = 5;
      }
      
      document.getElementById('editor').innerHTML = entry.text || '';
      document.getElementById('physical-activity').value = entry.physicalActivity || 5;
      document.getElementById('physical-activity-value').textContent = entry.physicalActivity || 5;
      document.getElementById('water-intake').value = entry.waterIntake || 0;
      document.getElementById('water-intake-value').textContent = entry.waterIntake || 0;
      
      updateHabitsList();
      
      const dateObj = new Date(date + 'T12:00:00');
      const dateString = dateObj.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      document.getElementById('emotion-date-label').textContent = `C√≥mo te sentiste el ${dateString}`;
    }

    function updateDaySummary(date) {
      const summaryElement = document.getElementById('day-summary');
      const entry = diaryData.entries[date];
      
      if (entry && Object.keys(entry).length > 0) {
        let html = '';
        if (entry.emotion) {
          const emotion = EMOTIONS.find(e => e.n === entry.emotion.name);
          html += `<p><strong>Emoci√≥n:</strong> ${emotion.e} ${entry.emotion.name} (Intensidad: ${entry.emotion.intensity}/10)</p>`;
        }
        if (entry.physicalActivity) html += `<p><strong>Actividad f√≠sica:</strong> ${entry.physicalActivity}/10</p>`;
        if (entry.waterIntake) html += `<p><strong>Vasos de agua:</strong> ${entry.waterIntake}</p>`;
        if (entry.text) html += `<p><strong>Entrada:</strong> ${entry.text.replace(/<[^>]*>/g, '').substring(0, 100)}...</p>`;
        summaryElement.innerHTML = html;
      } else {
        summaryElement.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No hay datos para este d√≠a</p>';
      }
    }

    function updateStats() {
      const entriesWithEmotions = getEntriesForPeriod(currentStatsPeriod).filter(entry => entry.emotion);
      const emotionChartCanvas = document.getElementById('emotion-chart');
      const noDataMessage = document.getElementById('emotion-chart-no-data');

      if (entriesWithEmotions.length === 0) {
        document.getElementById('wellness-index').textContent = 'N/A';
        document.getElementById('main-emotion').textContent = 'N/A';
        emotionChartCanvas.style.display = 'none';
        noDataMessage.style.display = 'block';
        if (emotionChartInstance) { emotionChartInstance.destroy(); emotionChartInstance = null; }
      } else {
        emotionChartCanvas.style.display = 'block';
        noDataMessage.style.display = 'none';
        const totalScore = entriesWithEmotions.reduce((sum, entry) => {
          const emotion = EMOTIONS.find(e => e.n === entry.emotion.name);
          return sum + (emotion.v * entry.emotion.intensity);
        }, 0);
        document.getElementById('wellness-index').textContent = (totalScore / entriesWithEmotions.length).toFixed(1);
        const emotionCounts = entriesWithEmotions.reduce((acc, entry) => {
          acc[entry.emotion.name] = (acc[entry.emotion.name] || 0) + 1;
          return acc;
        }, {});
        document.getElementById('main-emotion').textContent = Object.keys(emotionCounts).reduce((a, b) => emotionCounts[a] > emotionCounts[b] ? a : b, '--');
        updateEmotionChart();
      }

      updateHabitsStats();
      updateWellbeingStats();
      updateFinanceStats();
      updateFinanceCharts();
    }

    function getEntriesForPeriod(period) {
      const now = new Date();
      let startDate = new Date();
      if (period === 'week') startDate.setDate(now.getDate() - 7);
      else if (period === 'month') startDate.setMonth(now.getMonth() - 1);
      else if (period === 'year') startDate.setFullYear(now.getFullYear() - 1);
      else if (period === 'all') startDate = new Date(0);
      return Object.entries(diaryData.entries).filter(([date]) => new Date(date) >= startDate).map(([date, entry]) => ({ date, ...entry }));
    }

    function getTransactionsForPeriod(period) {
      const now = new Date();
      let startDate = new Date();
      if (period === 'week') startDate.setDate(now.getDate() - 7);
      else if (period === 'month') startDate.setMonth(now.getMonth() - 1);
      else if (period === 'year') startDate.setFullYear(now.getFullYear() - 1);
      else if (period === 'all') startDate = new Date(0);
      return (diaryData.transactions || []).filter(t => new Date(t.date) >= startDate);
    }
    
    function updateChart(chartInstance, elementId, config) {
        const ctx = document.getElementById(elementId)?.getContext('2d');
        if (!ctx) return null;
        if (chartInstance) chartInstance.destroy();
        return new Chart(ctx, config);
    }

    function updateEmotionChart() {
      const entries = getEntriesForPeriod(currentStatsPeriod).filter(e => e.emotion).sort((a, b) => new Date(a.date) - new Date(b.date));
      const labels = entries.map(e => new Date(e.date).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' }));
      const data = entries.map(e => EMOTIONS.find(em => em.n === e.emotion.name).v * e.emotion.intensity);
      emotionChartInstance = updateChart(emotionChartInstance, 'emotion-chart', {
        type: 'line', data: { labels, datasets: [{ label: '√çndice de Bienestar', data, borderColor: 'var(--accent-primary)', backgroundColor: 'rgba(99, 179, 237, 0.1)', tension: 0.4, fill: true }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: -20, max: 20 }, x: {} } }
      });
    }

    function updateBalanceDistributionChart() {
        const accounts = (diaryData.accounts || []).filter(a => a.balance > 0);
        balanceChartInstance = updateChart(balanceChartInstance, 'balance-distribution-chart', {
            type: 'doughnut', data: { labels: accounts.map(a => a.name), datasets: [{ data: accounts.map(a => a.balance), backgroundColor: ['#63b3ed', '#68d391', '#f6ad55', '#fc8181', '#e94560'] }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }

    function updateHabitsStats() {
      const list = document.getElementById('habits-stats-list');
      if (!diaryData.habits || diaryData.habits.length === 0) {
        list.innerHTML = '<li style="justify-content: center; color: var(--text-secondary);">No hay h√°bitos registrados</li>';
        return;
      }
      const entries = getEntriesForPeriod(currentStatsPeriod);
      const habitStats = diaryData.habits.map(habit => {
        const completedCount = entries.filter(e => e.habitsProgress && e.habitsProgress[habit.id] === habit.subcategories.length).length;
        return { ...habit, percentage: Math.round((completedCount / (entries.length || 1)) * 100) };
      }).sort((a, b) => b.percentage - a.percentage);
      list.innerHTML = habitStats.map(h => `<li><span>${h.text}</span><span style="color: var(--accent-primary); font-weight: 600;">${h.percentage}%</span></li>`).join('');
    }

    function updateWellbeingStats() {
        const entries = getEntriesForPeriod(currentStatsPeriod);
        const activityEntries = entries.filter(e => e.physicalActivity);
        const waterEntries = entries.filter(e => e.waterIntake);
        document.getElementById('avg-activity').textContent = activityEntries.length ? (activityEntries.reduce((sum, e) => sum + e.physicalActivity, 0) / activityEntries.length).toFixed(1) : '--';
        document.getElementById('avg-water').textContent = waterEntries.length ? (waterEntries.reduce((sum, e) => sum + e.waterIntake, 0) / waterEntries.length).toFixed(1) : '--';
        updateWellbeingChart();
    }

    function updateWellbeingChart() {
      const entries = getEntriesForPeriod(currentStatsPeriod).filter(e => e.physicalActivity || e.waterIntake).sort((a, b) => new Date(a.date) - new Date(b.date));
      wellbeingChartInstance = updateChart(wellbeingChartInstance, 'wellbeing-chart', {
        type: 'line', data: {
          labels: entries.map(e => new Date(e.date).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' })),
          datasets: [
            { label: 'Actividad F√≠sica', data: entries.map(e => e.physicalActivity || null), borderColor: 'var(--accent-primary)', yAxisID: 'y' },
            { label: 'Vasos de Agua', data: entries.map(e => e.waterIntake || null), borderColor: 'var(--success-color)', yAxisID: 'y1' }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: {
            y: { type: 'linear', position: 'left', min: 0, max: 10, title: { display: true, text: 'Actividad' } },
            y1: { type: 'linear', position: 'right', min: 0, max: 12, title: { display: true, text: 'Agua' }, grid: { drawOnChartArea: false } }
        } }
      });
    }

    function updateFinanceStats() {
      const transactions = getTransactionsForPeriod(currentStatsPeriod);
      document.getElementById('total-income').textContent = `$${transactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0).toFixed(2)}`;
      document.getElementById('total-expenses').textContent = `$${transactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0).toFixed(2)}`;
      updateFinanceCharts();
    }

    function updateFinanceCharts() {
      updateExpensesChart();
      updateFinanceTrendChart();
      updateBalanceDistributionChart();
    }

    function updateExpensesChart() {
      const expenses = getTransactionsForPeriod(currentStatsPeriod).filter(t => t.type === 'expense');
      const categories = expenses.reduce((acc, t) => {
        const cat = t.description.split(' ')[0] || 'Otros';
        acc[cat] = (acc[cat] || 0) + t.amount;
        return acc;
      }, {});
      expensesChartInstance = updateChart(expensesChartInstance, 'expenses-chart', {
        type: 'doughnut', data: { labels: Object.keys(categories), datasets: [{ data: Object.values(categories), backgroundColor: ['#3498db', '#2ecc71', '#f1c40f', '#e74c3c', '#9b59b6'] }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
      });
    }
    
    function updateFinanceTrendChart() {
      const transactions = getTransactionsForPeriod(currentStatsPeriod).sort((a,b) => new Date(a.date) - new Date(b.date));
      const dailyData = transactions.reduce((acc, t) => {
        if (!acc[t.date]) acc[t.date] = { income: 0, expense: 0 };
        acc[t.date][t.type] += t.amount;
        return acc;
      }, {});
      const dates = Object.keys(dailyData).sort();
      financeTrendChartInstance = updateChart(financeTrendChartInstance, 'finance-trend-chart', {
        type: 'bar', data: {
          labels: dates.map(d => new Date(d).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' })),
          datasets: [
            { label: 'Ingresos', data: dates.map(d => dailyData[d].income), backgroundColor: 'rgba(40, 167, 69, 0.7)' },
            { label: 'Gastos', data: dates.map(d => dailyData[d].expense), backgroundColor: 'rgba(220, 53, 69, 0.7)' }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    function updateExpenses() {
      updateAccountsList();
      updateTransactionsList();
      const totalBalance = (diaryData.accounts || []).reduce((sum, acc) => sum + acc.balance, 0);
      document.getElementById('total-balance').textContent = `$${totalBalance.toFixed(2)}`;
      const mainAccount = (diaryData.accounts || []).find(acc => acc.isDefault) || (diaryData.accounts || [])[0];
      if (mainAccount) {
        document.getElementById('main-account-balance').textContent = `$${mainAccount.balance.toFixed(2)}`;
        document.getElementById('main-account-name').textContent = mainAccount.name;
      }
    }

    function updateAccountsList() {
      const list = document.getElementById('accounts-list');
      const transactionAcc = document.getElementById('transaction-account'), transFrom = document.getElementById('transfer-from'), transTo = document.getElementById('transfer-to');
      
      if (!diaryData.accounts || diaryData.accounts.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No hay cuentas</p>';
        [transactionAcc, transFrom, transTo].forEach(s => s.innerHTML = '<option value="">No hay cuentas</option>');
        return;
      }

      list.innerHTML = diaryData.accounts.map(acc => `
        <div class="account-item ${acc.isDefault ? 'principal' : ''}">
          <div>
            <div style="font-weight: 600;">${acc.name} ${acc.isDefault ? '(Principal)' : ''}</div>
            <div class="account-balance">$${acc.balance.toFixed(2)}</div>
          </div>
          <div class="account-actions">
            <button class="btn-small btn-secondary" data-id="${acc.id}" data-action="edit">Editar</button>
            <button class="btn-small ${acc.isDefault ? 'btn-disabled" disabled' : 'btn-success" data-action="set-default"'}" data-id="${acc.id}">${acc.isDefault ? 'Principal' : 'Hacer Principal'}</button>
            ${!acc.isDefault ? `<button class="btn-small btn-danger" data-id="${acc.id}" data-action="delete">Eliminar</button>` : ''}
          </div>
        </div>
      `).join('');

      list.querySelectorAll('button[data-action]').forEach(btn => btn.addEventListener('click', e => {
        const id = parseInt(e.target.dataset.id);
        const action = e.target.dataset.action;
        if (action === 'edit') editAccount(id);
        else if (action === 'set-default') setDefaultAccount(id);
        else if (action === 'delete') deleteAccount(id);
      }));

      const options = diaryData.accounts.map(acc => `<option value="${acc.id}">${acc.name}</option>`).join('');
      transactionAcc.innerHTML = options;
      transFrom.innerHTML = '<option value="">Desde...</option>' + options;
      transTo.innerHTML = '<option value="">Hacia...</option>' + options;
    }

    function updateTransactionsList() {
      const list = document.getElementById('transactions-list');
      if (!diaryData.transactions || diaryData.transactions.length === 0) {
        list.innerHTML = '<li style="justify-content: center; color: var(--text-secondary);">No hay transacciones</li>';
        return;
      }
      const recent = [...diaryData.transactions].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
      list.innerHTML = recent.map(t => {
        const acc = (diaryData.accounts || []).find(a => a.id === t.accountId);
        return `
          <li>
            <div style="flex-grow: 1;">
              <div style="font-weight: 600;">${t.description}</div>
              <div style="font-size: 0.8rem; color: var(--text-secondary);">${acc ? acc.name : ''} ‚Ä¢ ${new Date(t.date).toLocaleDateString('es-ES')} ${t.recurring !== 'none' ? '‚Ä¢ üîÑ' : ''}</div>
            </div>
            <div style="color: ${t.type === 'income' ? 'var(--success-color)' : 'var(--error-color)'}; font-weight: 600;">
              ${t.type === 'income' ? '+' : '-'}$${t.amount.toFixed(2)}
            </div>
          </li>`;
      }).join('');
    }

    function showScreen(screenName) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      const screenEl = document.getElementById(screenName);
      if (screenEl) screenEl.classList.add('active');
    }

    function showModal(modalName) {
      const modalEl = document.getElementById(modalName);
      if(modalEl) modalEl.classList.add('active');
    }

    function createNewDiary() {
      const name = document.getElementById('owner-name-input').value.trim();
      if (!name) return showToast('Por favor, introduce tu nombre');
      
      diaryData = {
        ownerName: name,
        settings: { theme: 'pastel', password: null },
        entries: {},
        habits: [],
        accounts: [{ id: 1, name: 'Cuenta Principal', balance: 0, isDefault: true }],
        transactions: []
      };
      
      document.getElementById('diary-owner-name').textContent = `Diario de ${name}`;
      showScreen('main-diary-screen');
      switchBottomNav('diario');
      showToast(`¬°Bienvenido/a, ${name}!`);
      document.querySelector('.bottom-nav').classList.add('visible');
    }

    function saveEmotionData() {
      const selected = document.querySelector('.emotion-emoji.selected');
      if (selected) {
        if (!diaryData.entries[currentDate]) diaryData.entries[currentDate] = {};
        diaryData.entries[currentDate].emotion = {
          name: selected.dataset.name,
          intensity: parseInt(document.getElementById('emotion-intensity').value)
        };
        saveDataToLocalStorage();
      }
    }
    
    function saveWellbeingData() {
        if (!diaryData.entries[currentDate]) diaryData.entries[currentDate] = {};
        diaryData.entries[currentDate].physicalActivity = parseInt(document.getElementById('physical-activity').value);
        diaryData.entries[currentDate].waterIntake = parseInt(document.getElementById('water-intake').value);
        saveDataToLocalStorage();
    }

    function saveEntryText() {
      if (!diaryData.entries[currentDate]) diaryData.entries[currentDate] = {};
      diaryData.entries[currentDate].text = document.getElementById('editor').innerHTML;
      saveDataToLocalStorage();
    }

    function saveSettings() {
      const name = document.getElementById('diary-name-input').value.trim();
      const theme = document.getElementById('theme-selector').value;
      if (name) {
        diaryData.ownerName = name;
        document.getElementById('diary-owner-name').textContent = `Diario de ${name}`;
      }
      diaryData.settings.theme = theme;
      diaryData.settings.password = document.getElementById('password-input').value.trim() || null;
      document.body.className = `theme-${theme}`;
      showToast('Configuraci√≥n guardada');
      document.getElementById('settings-modal').classList.remove('active');
      saveDataToLocalStorage();
    }

    function addNewHabit() {
        const name = document.getElementById('new-habit-name').value.trim();
        const category = document.getElementById('new-habit-category').value.trim();
        const subcategoriesRaw = document.getElementById('new-habit-subcategories').value.trim();
        if (!name) return showToast('El nombre del h√°bito es obligatorio');
        
        const subcategories = subcategoriesRaw ? subcategoriesRaw.split(',').map(s => s.trim()).filter(s => s) : [];
        if (subcategories.length === 0) subcategories.push(name); // Si no hay subcategor√≠as, la tarea es el h√°bito mismo.
        
        if (!diaryData.habits) diaryData.habits = [];
        diaryData.habits.push({ id: Date.now(), text: name, category, subcategories });
        
        document.getElementById('new-habit-name').value = '';
        document.getElementById('new-habit-category').value = '';
        document.getElementById('new-habit-subcategories').value = '';
        
        updateHabitsList();
        updateHabitsManagementList();
        showToast('H√°bito agregado');
        saveDataToLocalStorage();
    }

    function editHabit(habitId) {
        const habit = diaryData.habits.find(h => h.id === habitId);
        if (!habit) return;
        editingHabitId = habitId;
        document.getElementById('edit-habit-name').value = habit.text;
        document.getElementById('edit-habit-category').value = habit.category || '';
        document.getElementById('edit-habit-subcategories').value = habit.subcategories.join(', ');
        showModal('edit-habit-modal');
    }

    function saveHabitChanges() {
        if (!editingHabitId) return;
        const habit = diaryData.habits.find(h => h.id === editingHabitId);
        if (!habit) return;

        const name = document.getElementById('edit-habit-name').value.trim();
        if (!name) return showToast('El nombre no puede estar vac√≠o');
        
        habit.text = name;
        habit.category = document.getElementById('edit-habit-category').value.trim();
        const subcategoriesRaw = document.getElementById('edit-habit-subcategories').value.trim();
        habit.subcategories = subcategoriesRaw ? subcategoriesRaw.split(',').map(s => s.trim()).filter(s => s) : [name];
        
        document.getElementById('edit-habit-modal').classList.remove('active');
        updateHabitsManagementList();
        updateHabitsList();
        showToast('H√°bito actualizado');
        editingHabitId = null;
        saveDataToLocalStorage();
    }

    function deleteHabit(habitId) {
        diaryData.habits = diaryData.habits.filter(h => h.id !== habitId);
        // Tambi√©n limpiar el progreso de este h√°bito en todas las entradas
        Object.values(diaryData.entries).forEach(entry => {
            if (entry.habitsProgress && entry.habitsProgress[habitId]) {
                delete entry.habitsProgress[habitId];
            }
        });
        updateHabitsList();
        updateHabitsManagementList();
        showToast('H√°bito eliminado');
        saveDataToLocalStorage();
    }


    function updateHabitsList() {
        const habitsContainer = document.getElementById('habits-list');
        if (!diaryData.habits || diaryData.habits.length === 0) {
            habitsContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No hay h√°bitos registrados. Ve a la secci√≥n de H√°bitos para agregar.</p>';
            return;
        }

        const progress = (diaryData.entries[currentDate] || {}).habitsProgress || {};

        habitsContainer.innerHTML = diaryData.habits.map(habit => {
            const steps = habit.subcategories.length;
            const currentStep = progress[habit.id] || 0;
            const subcategoryText = currentStep > 0 ? habit.subcategories[currentStep - 1] : "Sin empezar";
            return `
                <div class="habit-item">
                    <div class="habit-item-header">
                        <span class="habit-title">${habit.text}</span>
                        ${habit.category ? `<span class="habit-category">${habit.category}</span>` : ''}
                    </div>
                    <input type="range" class="habit-slider" data-id="${habit.id}" min="0" max="${steps}" step="1" value="${currentStep}">
                    <div class="habit-subcategory-label" id="label-habit-${habit.id}">${subcategoryText} (${currentStep}/${steps})</div>
                </div>
            `;
        }).join('');

        habitsContainer.querySelectorAll('.habit-slider').forEach(slider => {
            slider.addEventListener('input', e => {
                const habitId = e.target.dataset.id;
                const value = parseInt(e.target.value);
                const habit = diaryData.habits.find(h => h.id == habitId);
                const label = document.getElementById(`label-habit-${habitId}`);

                if (!diaryData.entries[currentDate]) diaryData.entries[currentDate] = {};
                if (!diaryData.entries[currentDate].habitsProgress) diaryData.entries[currentDate].habitsProgress = {};
                diaryData.entries[currentDate].habitsProgress[habitId] = value;

                const subcategoryText = value > 0 ? habit.subcategories[value - 1] : "Sin empezar";
                label.textContent = `${subcategoryText} (${value}/${habit.subcategories.length})`;
            });
            slider.addEventListener('change', () => saveDataToLocalStorage());
        });
    }

    function updateHabitsManagementList() {
        const managementList = document.getElementById('habits-management-list');
        if (!diaryData.habits || diaryData.habits.length === 0) {
            managementList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No hay h√°bitos registrados</p>';
            return;
        }

        managementList.innerHTML = diaryData.habits.map(habit => `
            <div class="account-item">
                <div>
                    <span style="font-weight: 600;">${habit.text}</span>
                    <div style="font-size: 0.8em; color: var(--text-secondary);">${habit.category || 'Sin categor√≠a'}</div>
                </div>
                <div class="account-actions">
                  <button class="btn-small btn-secondary" data-id="${habit.id}" data-action="edit">Editar</button>
                  <button class="btn-small btn-danger" data-id="${habit.id}" data-action="delete">Eliminar</button>
                </div>
            </div>
        `).join('');

        managementList.querySelectorAll('button[data-action]').forEach(button => {
            button.addEventListener('click', function() {
                const habitId = parseInt(this.dataset.id);
                const action = this.dataset.action;
                if (action === 'delete') deleteHabit(habitId);
                else if (action === 'edit') editHabit(habitId);
            });
        });
    }


    function addNewTransaction() {
      const type = document.getElementById('transaction-type').value;
      const amount = parseFloat(document.getElementById('transaction-amount').value);
      const description = document.getElementById('transaction-description').value.trim();
      const accountId = parseInt(document.getElementById('transaction-account').value);
      const recurring = document.getElementById('transaction-recurring').value;
      
      if (isNaN(amount) || amount <= 0 || !description || isNaN(accountId)) return showToast('Completa todos los campos');
      const account = diaryData.accounts.find(a => a.id === accountId);
      if (!account) return showToast('Cuenta no v√°lida');
      
      if (type === 'income') account.balance += amount; else account.balance -= amount;
      
      const newTransaction = { id: Date.now(), type, amount, description, accountId, date: currentDate, recurring };
      if (recurring !== 'none' && document.getElementById('recurring-start-date').value) {
        newTransaction.recurringStart = document.getElementById('recurring-start-date').value;
        newTransaction.recurringEnd = document.getElementById('recurring-end-date').value || null;
      }
      
      if (!diaryData.transactions) diaryData.transactions = [];
      diaryData.transactions.push(newTransaction);
      document.getElementById('transaction-amount').value = '';
      document.getElementById('transaction-description').value = '';
      toggleRecurringOptions(true);
      updateExpenses();
      showToast('Transacci√≥n agregada');
      saveDataToLocalStorage();
    }

    function addNewAccount() {
      const name = document.getElementById('new-account-name').value.trim();
      if (!name) return showToast('Ingresa un nombre para la cuenta');
      
      diaryData.accounts.push({ id: Date.now(), name, balance: parseFloat(document.getElementById('new-account-balance').value) || 0, isDefault: false });
      document.getElementById('new-account-name').value = '';
      document.getElementById('new-account-balance').value = '0';
      updateExpenses();
      showToast('Cuenta agregada');
      saveDataToLocalStorage();
    }

    function editAccount(accountId) {
      const account = diaryData.accounts.find(a => a.id === accountId);
      if (!account) return;
      editingAccountId = accountId;
      document.getElementById('edit-account-name').value = account.name;
      document.getElementById('edit-account-balance').value = account.balance;
      showModal('edit-account-modal');
    }

    function saveAccountChanges() {
      if (!editingAccountId) return;
      const account = diaryData.accounts.find(a => a.id === editingAccountId);
      const newName = document.getElementById('edit-account-name').value.trim();
      const newBalance = parseFloat(document.getElementById('edit-account-balance').value);
      if (!account || !newName || isNaN(newBalance)) return showToast('Datos inv√°lidos');
      
      account.name = newName; account.balance = newBalance;
      document.getElementById('edit-account-modal').classList.remove('active');
      updateExpenses();
      showToast('Cuenta actualizada');
      editingAccountId = null;
      saveDataToLocalStorage();
    }

    function transferBetweenAccounts() {
      const fromId = parseInt(document.getElementById('transfer-from').value);
      const toId = parseInt(document.getElementById('transfer-to').value);
      const amount = parseFloat(document.getElementById('transfer-amount').value);
      
      if (isNaN(fromId) || isNaN(toId) || isNaN(amount) || amount <= 0 || fromId === toId) return showToast('Datos de transferencia inv√°lidos');
      const fromAcc = diaryData.accounts.find(a => a.id === fromId), toAcc = diaryData.accounts.find(a => a.id === toId);
      if (!fromAcc || !toAcc || fromAcc.balance < amount) return showToast('Fondos insuficientes o cuenta no v√°lida');
      
      fromAcc.balance -= amount; toAcc.balance += amount;
      diaryData.transactions.push({ id: Date.now(), type: 'transfer', amount, description: `Transferencia a ${toAcc.name}`, accountId: fromId, date: currentDate, recurring: 'none' });
      document.getElementById('transfer-amount').value = '';
      updateExpenses();
      showToast('Transferencia realizada');
      saveDataToLocalStorage();
    }

    function deleteAccount(accountId) {
      const account = diaryData.accounts.find(a => a.id === accountId);
      if (!account || account.isDefault) return showToast('No puedes eliminar la cuenta principal');
      if (account.balance > 0 && !confirm(`La cuenta "${account.name}" tiene saldo. ¬øSeguro que quieres eliminarla?`)) return;
      
      const defaultAccount = diaryData.accounts.find(a => a.isDefault);
      if (defaultAccount) diaryData.transactions.forEach(t => { if (t.accountId === accountId) t.accountId = defaultAccount.id; });
      diaryData.accounts = diaryData.accounts.filter(a => a.id !== accountId);
      updateExpenses();
      showToast('Cuenta eliminada');
      saveDataToLocalStorage();
    }

    function setDefaultAccount(accountId) {
      diaryData.accounts.forEach(acc => acc.isDefault = (acc.id === accountId));
      updateExpenses();
      showToast('Cuenta principal actualizada');
      saveDataToLocalStorage();
    }

    function toggleRecurringOptions(reset = false) {
      const select = document.getElementById('transaction-recurring'), options = document.getElementById('recurring-options');
      if (reset) {
        select.value = 'none';
        document.getElementById('recurring-start-date').value = '';
        document.getElementById('recurring-end-date').value = '';
      }
      options.style.display = select.value !== 'none' ? 'block' : 'none';
      if (select.value !== 'none' && !document.getElementById('recurring-start-date').value) document.getElementById('recurring-start-date').value = currentDate;
    }

    function exportDiary() {
      if (!diaryData.ownerName) return showToast('No hay diario para exportar');
      
      const xmlData = `<?xml version="1.0" encoding="UTF-8"?>
<diary owner="${diaryData.ownerName}">
  <settings>
    <theme>${diaryData.settings.theme}</theme>
    ${diaryData.settings.password ? `<password>${diaryData.settings.password}</password>` : ''}
  </settings>
  <habits>
    ${(diaryData.habits || []).map(h => `<habit id="${h.id}" text="${h.text}" category="${h.category || ''}"><subcategories>${h.subcategories.map(s => `<subcat>${s}</subcat>`).join('')}</subcategories></habit>`).join('')}
  </habits>
  <accounts>
    ${(diaryData.accounts || []).map(a => `<account id="${a.id}" name="${a.name}" balance="${a.balance}" isDefault="${a.isDefault}"/>`).join('')}
  </accounts>
  <entries>
    ${Object.entries(diaryData.entries).map(([date, entry]) => `
    <entry date="${date}">
      ${entry.emotion ? `<emotion name="${entry.emotion.name}" intensity="${entry.emotion.intensity}"/>` : ''}
      ${entry.text ? `<content><![CDATA[${entry.text}]]></content>` : ''}
      ${entry.physicalActivity ? `<physicalActivity>${entry.physicalActivity}</physicalActivity>` : ''}
      ${entry.waterIntake ? `<waterIntake>${entry.waterIntake}</waterIntake>` : ''}
      ${entry.habitsProgress ? `<habitsProgress>${Object.entries(entry.habitsProgress).map(([id,p]) => `<habit id="${id}" progress="${p}"/>`).join('')}</habitsProgress>` : ''}
    </entry>`).join('')}
  </entries>
  <transactions>
    ${(diaryData.transactions || []).map(t => `<transaction id="${t.id}" type="${t.type}" amount="${t.amount}" accountId="${t.accountId}" date="${t.date}" recurring="${t.recurring}"><description>${t.description}</description></transaction>`).join('')}
  </transactions>
</diary>`;
      
      const blob = new Blob([xmlData], { type: 'application/xml' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `diario_${diaryData.ownerName.replace(/ /g, '_')}.xml`;
      a.click();
      URL.revokeObjectURL(a.href);
      showToast('Diario exportado correctamente');
    }

    function handleFileImport(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(event.target.result, 'application/xml');
          if (xmlDoc.querySelector('parsererror')) throw new Error('XML parsing error');

          diaryData = {
            ownerName: xmlDoc.querySelector('diary').getAttribute('owner'),
            settings: { theme: xmlDoc.querySelector('settings > theme')?.textContent || 'pastel', password: null },
            habits: Array.from(xmlDoc.querySelectorAll('habits > habit')).map(h => ({ id: parseInt(h.getAttribute('id')), text: h.getAttribute('text'), category: h.getAttribute('category'), subcategories: Array.from(h.querySelectorAll('subcat')).map(s => s.textContent) })),
            accounts: Array.from(xmlDoc.querySelectorAll('accounts > account')).map(a => ({ id: parseInt(a.getAttribute('id')), name: a.getAttribute('name'), balance: parseFloat(a.getAttribute('balance')), isDefault: a.getAttribute('isDefault') === 'true' })),
            entries: {},
            transactions: Array.from(xmlDoc.querySelectorAll('transactions > transaction')).map(t => ({ id: parseInt(t.getAttribute('id')), type: t.getAttribute('type'), amount: parseFloat(t.getAttribute('amount')), accountId: parseInt(t.getAttribute('accountId')), date: t.getAttribute('date'), recurring: t.getAttribute('recurring'), description: t.querySelector('description').textContent }))
          };

          Array.from(xmlDoc.querySelectorAll('entries > entry')).forEach(entryNode => {
              const date = entryNode.getAttribute('date');
              const entry = {};
              const emotionNode = entryNode.querySelector('emotion');
              if (emotionNode) entry.emotion = { name: emotionNode.getAttribute('name'), intensity: parseInt(emotionNode.getAttribute('intensity')) };
              entryNode.querySelector('content') && (entry.text = entryNode.querySelector('content').textContent);
              entryNode.querySelector('physicalActivity') && (entry.physicalActivity = parseInt(entryNode.querySelector('physicalActivity').textContent));
              entryNode.querySelector('waterIntake') && (entry.waterIntake = parseInt(entryNode.querySelector('waterIntake').textContent));
              const habitsNode = entryNode.querySelector('habitsProgress');
              if (habitsNode) {
                  entry.habitsProgress = Array.from(habitsNode.querySelectorAll('habit')).reduce((acc, h) => {
                      acc[h.getAttribute('id')] = parseInt(h.getAttribute('progress'));
                      return acc;
                  }, {});
              }
              diaryData.entries[date] = entry;
          });
          
          document.getElementById('diary-owner-name').textContent = `Diario de ${diaryData.ownerName}`;
          document.body.className = `theme-${diaryData.settings.theme}`;
          document.getElementById('theme-selector').value = diaryData.settings.theme;
          document.getElementById('diary-name-input').value = diaryData.ownerName;
          
          showScreen('main-diary-screen');
          switchBottomNav('diario');
          updateHabitsList();
          updateExpenses();
          showToast('Diario importado correctamente');
          document.querySelector('.bottom-nav').classList.add('visible');
          saveDataToLocalStorage();

        } catch (error) {
          console.error('Error al importar:', error);
          showToast('Error al importar el archivo.');
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    }

    function showToast(message, duration = 3000) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), duration);
    }

    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    function resetDiary() {
      if (confirm('¬øEst√°s seguro? Se borrar√° TODO. Esta acci√≥n no se puede deshacer.')) {
        localStorage.removeItem('diarioMojiData');
        location.reload();
      }
    }

    function saveDataToLocalStorage() {
      if (diaryData && diaryData.ownerName) {
        localStorage.setItem('diarioMojiData', JSON.stringify(diaryData));
      }
    }

    function loadDataFromLocalStorage() {
      const savedData = localStorage.getItem('diarioMojiData');
      if (savedData) {
        diaryData = JSON.parse(savedData);
        // Migraci√≥n de datos viejos de h√°bitos si es necesario
        if (diaryData.habits && diaryData.habits.length > 0 && !diaryData.habits[0].subcategories) {
            diaryData.habits.forEach(h => {
                if (!h.subcategories) h.subcategories = [h.text];
            });
            Object.values(diaryData.entries).forEach(entry => {
                if (entry.completedHabits) {
                    entry.habitsProgress = {};
                    entry.completedHabits.forEach(habitId => {
                        const habit = diaryData.habits.find(h => h.id === habitId);
                        if(habit) entry.habitsProgress[habitId] = habit.subcategories.length;
                    });
                    delete entry.completedHabits;
                }
            });
            showToast("Datos de h√°bitos actualizados al nuevo formato.");
            saveDataToLocalStorage();
        }
        return true;
      }
      return false;
    }

    initApp();
  });
  </script>
</body>
</html>
